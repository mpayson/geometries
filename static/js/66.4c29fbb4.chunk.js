(this.webpackJsonpgeometries=this.webpackJsonpgeometries||[]).push([[66],{1059:function(e,t,r){"use strict";r.d(t,"a",(function(){return g}));var n=r(9),a=r(12),i=r(10),s=r.n(i),u=r(21),o=r(2),c=r(3),l=r(13),h=r(4),f=r(16),d=r(245),v=r(805),p=r(14);var y=function(e,t,r){e.referencesGeometry();var a=t.readArcadeFeature();try{return e.evaluate(Object(n.a)(Object(n.a)({},r),{},{$feature:a}))}catch(e){return p.a.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",e),null}},b=r.e(141).then(r.bind(null,1280)),g=function(){function e(t,r){Object(o.a)(this,e),this._canCacheExpressionValue=!1,this._sourceInfo=t,this._bitsets={computed:r.getBitset(r.createBitset())}}return Object(c.a)(e,[{key:"updateSchema",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r){var n,a,i,u,o,c;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=Object(v.a)(this._schema,r),this._schema=r,r&&!Object(h.h)(n)&&Object(v.b)(n,"attributes")){e.next=3;break}return e.abrupt("return");case 3:Object(l.a)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",n),this._bitsets.computed.clear(),t.targets[r.name]=!0,a=r.attributes,i=[],u=[],e.t0=s.a.keys(a);case 6:if((e.t1=e.t0()).done){e.next=20;break}o=e.t1.value,c=a[o],e.t2=c.type,e.next="field"===e.t2?12:"expression"===e.t2?13:"label-expression"===e.t2?15:"statistic"===e.t2?17:18;break;case 12:return e.abrupt("break",18);case 13:return i.push(this._createArcadeComputedField(c)),e.abrupt("break",18);case 15:return i.push(this._createLabelArcadeComputedField(c)),e.abrupt("break",18);case 17:u.push(c);case 18:e.next=6;break;case 20:return e.next=22,Object(f.b)(i);case 22:this._computedFields=e.sent,this._canCacheExpressionValue=!this._computedFields.some((function(e){return"expression"===e.type&&e.expression.referencesScale()})),this._statisticFields=u;case 25:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"setComputedAttributes",value:function(e,t,r,n){var i=this._bitsets.computed;if(!this._canCacheExpressionValue||!i.has(r)){i.set(r);var s,u=Object(a.a)(this._computedFields);try{for(u.s();!(s=u.n()).done;){var o=s.value,c=this._evaluateField(t,o,n);switch(o.resultType){case"numeric":e.setComputedNumericAtIndex(r,o.fieldIndex,c);break;case"string":e.setComputedStringAtIndex(r,o.fieldIndex,c)}}}catch(l){u.e(l)}finally{u.f()}}}},{key:"_createArcadeComputedField",value:function(){var e=Object(u.a)(s.a.mark((function e(t){var r,a;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._sourceInfo.spatialReference,a=this._sourceInfo.fieldsIndex,e.t0=n.a,e.t1=Object(n.a)({},t),e.t2={},e.next=6,Object(d.d)(t.valueExpression,r,a);case 6:return e.t3=e.sent,e.t4={expression:e.t3},e.abrupt("return",(0,e.t0)(e.t1,e.t2,e.t4));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createLabelArcadeComputedField",value:function(){var e=Object(u.a)(s.a.mark((function e(t){var r,a,i,u,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._sourceInfo.spatialReference,a=this._sourceInfo.fields,e.next=4,b;case 4:return i=e.sent,u=i.createLabelFunction,e.next=8,u(t.label,a,r);case 8:return o=e.sent,e.abrupt("return",Object(n.a)(Object(n.a)({},t),{},{builder:o}));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_evaluateField",value:function(e,t,r){switch(t.type){case"label-expression":var n=e.readArcadeFeature();return t.builder.evaluate(n)||"";case"expression":var a=t.expression;return y(a,e,{$view:{scale:r}})}}}]),e}()},1075:function(e,t,r){"use strict";r.d(t,"a",(function(){return F})),r.d(t,"b",(function(){return S})),r.d(t,"c",(function(){return w}));var n=r(32),a=r(10),i=r.n(a),s=r(12),u=r(23),o=r(202),c=r(142),l=i.a.mark(v),h=i.a.mark(p);function f(e){var t=[];return e.forEach((function(e){return t.push(e)})),t}var d={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function v(e){var t,r,n;return i.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:a.t0=e.type,a.next="Feature"===a.t0?3:"FeatureCollection"===a.t0?6:25;break;case 3:return a.next=5,e;case 5:return a.abrupt("break",25);case 6:t=Object(s.a)(e.features),a.prev=7,t.s();case 9:if((r=t.n()).done){a.next=17;break}if(n=r.value,a.t1=n,!a.t1){a.next=15;break}return a.next=15,n;case 15:a.next=9;break;case 17:a.next=22;break;case 19:a.prev=19,a.t2=a.catch(7),t.e(a.t2);case 22:return a.prev=22,t.f(),a.finish(22);case 25:case"end":return a.stop()}}),l,null,[[7,19,22,25]])}function p(e){var t,r,n,a,u,o,c,l,f;return i.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(e){i.next=2;break}return i.abrupt("return",null);case 2:i.t0=e.type,i.next="Point"===i.t0?5:"LineString"===i.t0||"MultiPoint"===i.t0?8:"MultiLineString"===i.t0||"Polygon"===i.t0?10:"MultiPolygon"===i.t0?27:58;break;case 5:return i.next=7,e.coordinates;case 7:return i.abrupt("break",58);case 8:return i.delegateYield(e.coordinates,"t1",9);case 9:return i.abrupt("break",58);case 10:t=Object(s.a)(e.coordinates),i.prev=11,t.s();case 13:if((r=t.n()).done){i.next=18;break}return n=r.value,i.delegateYield(n,"t2",16);case 16:i.next=13;break;case 18:i.next=23;break;case 20:i.prev=20,i.t3=i.catch(11),t.e(i.t3);case 23:return i.prev=23,t.f(),i.finish(23);case 26:return i.abrupt("break",58);case 27:a=Object(s.a)(e.coordinates),i.prev=28,a.s();case 30:if((u=a.n()).done){i.next=50;break}o=u.value,c=Object(s.a)(o),i.prev=33,c.s();case 35:if((l=c.n()).done){i.next=40;break}return f=l.value,i.delegateYield(f,"t4",38);case 38:i.next=35;break;case 40:i.next=45;break;case 42:i.prev=42,i.t5=i.catch(33),c.e(i.t5);case 45:return i.prev=45,c.f(),i.finish(45);case 48:i.next=30;break;case 50:i.next=55;break;case 52:i.prev=52,i.t6=i.catch(28),a.e(i.t6);case 55:return i.prev=55,a.f(),i.finish(55);case 58:case"end":return i.stop()}}),h,null,[[11,20,23,26],[28,52,55,58],[33,42,45,48]])}function y(e){for(;;){var t=e.next(),r=t.value;if(t.done)return!1;if(r.length>2)return!0}}function b(e){for(var t=0,r=0;r<e.length;r++){var n=e[r],a=e[(r+1)%e.length];t+=n[0]*a[1]-a[0]*n[1]}return t<=0}function g(e){var t=e[0],r=e[e.length-1];return t[0]===r[0]&&t[1]===r[1]&&t[2]===r[2]||e.push(t),e}function _(e,t,r){switch(t.type){case"LineString":return function(e,t,r){return x(e,t.coordinates,r),e}(e,t,r);case"MultiLineString":return function(e,t,r){var n,a=Object(s.a)(t.coordinates);try{for(a.s();!(n=a.n()).done;){x(e,n.value,r)}}catch(i){a.e(i)}finally{a.f()}return e}(e,t,r);case"MultiPoint":return function(e,t,r){return x(e,t.coordinates,r),e}(e,t,r);case"MultiPolygon":return function(e,t,r){var n,a=Object(s.a)(t.coordinates);try{for(a.s();!(n=a.n()).done;){var i=n.value;m(e,i[0],r);for(var u=1;u<i.length;u++)k(e,i[u],r)}}catch(o){a.e(o)}finally{a.f()}return e}(e,t,r);case"Point":return function(e,t,r){return j(e,t.coordinates,r),e}(e,t,r);case"Polygon":return function(e,t,r){var n=t.coordinates;m(e,n[0],r);for(var a=1;a<n.length;a++)k(e,n[a],r);return e}(e,t,r)}}function m(e,t,r){var n=g(t);b(n)?x(e,n,r):O(e,n,r)}function k(e,t,r){var n=g(t);b(n)?O(e,n,r):x(e,n,r)}function x(e,t,r){var n,a=Object(s.a)(t);try{for(a.s();!(n=a.n()).done;){j(e,n.value,r)}}catch(i){a.e(i)}finally{a.f()}e.lengths.push(t.length)}function O(e,t,r){for(var n=t.length-1;n>=0;n--)j(e,t[n],r);e.lengths.push(t.length)}function j(e,t,r){var a=Object(n.a)(t,3),i=a[0],s=a[1],u=a[2];e.coords.push(i,s),r.hasZ&&e.coords.push(u||0)}function I(e){switch(typeof e){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function w(e){if(!e)throw new u.a("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==e.type&&"FeatureCollection"!==e.type)throw new u.a("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:e});var t=e.crs;if(t){var r="string"==typeof t?t:"name"===t.type?t.properties.name:null,n=new RegExp(".*(CRS84H?|4326)$","i");if(!r||!n.test(r))throw new u.a("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:t})}}function S(e){for(var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=v(e),a=[],i=new Set,u=new Set,o=!1,c=Number.NEGATIVE_INFINITY,l=null,h=!1,b=r.geometryType,g=void 0===b?null:b,_=!1,m=function(){var e=n.next(),r=e.value;if(e.done){var v=l&&1===l.length&&l[0]||null;if(v){var b,m=Object(s.a)(a);try{for(m.s();!(b=m.n()).done;){var k=b.value;k.name===v&&(k.type="esriFieldTypeOID")}}catch(C){m.e(C)}finally{m.f()}}return{v:{fields:a,geometryType:g,hasZ:o,maxObjectId:Math.max(0,c),objectIdFieldName:v,objectIdFieldType:t,unknownFields:f(u)}}}var x=r.geometry,O=r.properties,j=r.id;if((!x||(g||(g=d[x.type]),d[x.type]===g))&&(o||(o=y(p(x))),h||(h=null!=j)&&("number"===(t=typeof j)&&(l=Object.keys(O).filter((function(e){return O[e]===j})))),h&&"number"===t&&null!=j&&(c=Math.max(c,j),l.length>1?l=l.filter((function(e){return O[e]===j})):1===l.length&&(l=O[l[0]]===j?l:[])),!_&&O)){var w=!0;for(var S in O)if(!i.has(S)){var F=O[S];if(null!=F){var T=I(F);"unknown"!==T?(u.delete(S),i.add(S),a.push({name:S,alias:S,type:T})):u.add(S)}else w=!1,u.add(S)}_=w}};;){var k=m();if("object"===typeof k)return k.v}}function F(e,t){return function(e){for(var t=[];;){var r=e.next(),n=r.value;if(r.done)return t;t.push(n)}}(i.a.mark((function e(t){var r,n,a,s,u,l,h,f,v,p,y=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=y.length>1&&void 0!==y[1]?y[1]:{},n=r.geometryType,a=r.objectIdFieldName;case 2:if(s=t.next(),u=s.value,!s.done){e.next=5;break}return e.abrupt("return");case 5:if(l=u.geometry,h=u.properties,f=u.id,!l||d[l.type]===n){e.next=8;break}return e.abrupt("continue",13);case 8:return v=h||{},a&&null!=f&&!v[a]&&(v[a]=f),p=new o.a(l?_(new c.a,l,r):null,v),e.next=13,p;case 13:e.next=2;break;case 15:case"end":return e.stop()}}),e)}))(v(e),t))}},1077:function(e,t,r){"use strict";r.d(t,"a",(function(){return y})),r.d(t,"b",(function(){return p}));var n=r(12),a=r(2),i=r(3),s=r(5),u=r(6),o=r(4),c=r(76),l=r(131),h=r(857),f=r(1059);function d(e){return(4294901760&e)>>>16}function v(e){return 65535&e}var p={getObjectId:function(e){return e.getObjectId()},getAttributes:function(e){return e.readAttributes()},getAttribute:function(e,t){return e.readAttribute(t)},cloneWithGeometry:function(e,t){return e},getGeometry:function(e){return e.readHydratedGeometry()},getCentroid:function(e,t){return e.readCentroid()}},y=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e,n){var i;return Object(a.a)(this,r),(i=t.call(this,e,n)).featureAdapter=p,i.events=new c.a,i._featureSetsByInstance=new Map,i._objectIdToDisplayId=new Map,i._spatialIndexInvalid=!0,i._index=Object(h.a)(9,(function(e){return{minX:i._storage.getXMin(e),minY:i._storage.getYMin(e),maxX:i._storage.getXMax(e),maxY:i._storage.getYMax(e)}})),i}return Object(i.a)(r,[{key:"storeStatistics",get:function(){return{featureCount:0,vertexCount:0}}},{key:"onTileData",value:function(e,t,r){if(Object(o.h)(t.addOrUpdate))return t;this._featureSetsByInstance.set(t.addOrUpdate.instance,t.addOrUpdate),this._storage=r,t.addOrUpdate._storage=r;for(var n=t.addOrUpdate.getCursor();n.next();){var a=n.getObjectId(),i=n.instance<<16|n.getIndex(),s=this._objectIdToDisplayId.get(a);s||(s=r.createDisplayId(),this._objectIdToDisplayId.set(a,s),this._spatialIndexInvalid=!0),n.setDisplayId(s),r.setInstanceId(s,i),this.setComputedAttributes(r,n,s,e.scale)}return"update"===t.type&&(this._spatialIndexInvalid=!0),this.events.emit("changed"),t}},{key:"forEach",value:function(e){var t=this;this._objectIdToDisplayId.forEach((function(r){var n=t._storage.getInstanceId(r),a=t._lookupFeature(n);e(a)}))}},{key:"forEachUnsafe",value:function(e){var t=this;this._objectIdToDisplayId.forEach((function(r){var n=t._storage.getInstanceId(r),a=d(n),i=v(n),s=t._getFeatureSet(a);s.setIndex(i),e(s)}))}},{key:"forEachInBounds",value:function(e,t){var r,a=this._searchIndex(e),i=Object(n.a)(a);try{for(i.s();!(r=i.n()).done;){var s=r.value,u=this.lookupFeatureByDisplayId(s,this._storage);t(Object(o.o)(u))}}catch(c){i.e(c)}finally{i.f()}}},{key:"forEachBounds",value:function(e,t,r){this._rebuildIndex();var a,i=[0,0,0,0],s=Object(n.a)(e);try{for(s.s();!(a=s.n()).done;){var u=a.value;if(u.readGeometry()){var o=u.getDisplayId();i[0]=this._storage.getXMin(o),i[1]=this._storage.getYMin(o),i[2]=this._storage.getXMax(o),i[3]=this._storage.getYMax(o),t(Object(l.k)(r,i))}}}catch(c){s.e(c)}finally{s.f()}}},{key:"sweepFeatures",value:function(e,t,r){var n=this;this._objectIdToDisplayId.forEach((function(a,i){e.has(a)||(t.releaseDisplayId(a),r.unsetAttributeData(a),n._objectIdToDisplayId.delete(i))})),this.events.emit("changed")}},{key:"sweepFeatureSets",value:function(e){var t=this;this._featureSetsByInstance.forEach((function(r,n){e.has(n)||t._featureSetsByInstance.delete(n)}))}},{key:"lookupObjectId",value:function(e,t){var r=this.lookupFeatureByDisplayId(e,t);return Object(o.h)(r)?null:r.getObjectId()}},{key:"lookupDisplayId",value:function(e){return this._objectIdToDisplayId.get(e)}},{key:"lookupFeatureByDisplayId",value:function(e,t){var r=t.getInstanceId(e);return this._lookupFeature(r)}},{key:"lookupByDisplayIdUnsafe",value:function(e){var t=this._storage.getInstanceId(e),r=d(t),n=v(t),a=this._getFeatureSet(r);return a?(a.setIndex(n),a):null}},{key:"hasInstance",value:function(e){return this._featureSetsByInstance.has(e)}},{key:"_rebuildIndex",value:function(){var e=this;if(this._spatialIndexInvalid){this._index.clear();var t=[];this._objectIdToDisplayId.forEach((function(r){var n=e._storage.getInstanceId(r);e._storage.setBounds(r,e._lookupFeature(n))&&t.push(r)})),this._index.load(t),this._spatialIndexInvalid=!1}}},{key:"_lookupFeature",value:function(e){var t=d(e),r=v(e),n=this._getFeatureSet(t);if(!n)return null;var a=n.getCursor();return a.setIndex(r),a}},{key:"_getFeatureSet",value:function(e){return this._featureSetsByInstance.get(e)}},{key:"_searchIndex",value:function(e){this._rebuildIndex();var t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}}]),r}(f.a)},1292:function(e,t,r){"use strict";r.r(t),r.d(t,"getInstances",(function(){return pt}));var n=r(10),a=r.n(n),i=r(21),s=r(2),u=r(3),o=r(5),c=r(6),l=r(0),h=r(13),f=r(14),d=(r(15),r(1)),v=r(8),p=(r(11),r(19),r(20),r(16)),y=r(158),b=r(383),g=r(375),_=r(394),m=r(900);function k(e){return"heatmap"===e?r.e(110).then(r.bind(null,1279)):Promise.all([r.e(8),r.e(31),r.e(51)]).then(r.bind(null,1316))}var x=r(12),O=function(){function e(){Object(s.a)(this,e),this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}return Object(u.a)(e,[{key:"any",value:function(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}},{key:"describe",value:function(){var e=0,t="";if(this.mesh){e+=20,t+="-> (20) Mesh needs update\n";var r,n=Object(x.a)(this.why.mesh);try{for(n.s();!(r=n.n()).done;){var a=r.value;t+="    + ".concat(a,"\n")}}catch(c){n.e(c)}finally{n.f()}}if(this.source){e+=10,t+="-> (10) The source needs update\n";var i,s=Object(x.a)(this.why.source);try{for(s.s();!(i=s.n()).done;){var u=i.value;t+="    + ".concat(u,"\n")}}catch(c){s.e(c)}finally{s.f()}}this.targets.feature&&(e+=5,t+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(e+=5,t+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(e+=4,t+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(e+=1,t+="-> (1) Texture storage parameters changed");var o=e<5?"Fastest":e<10?"Fast":e<15?"Moderate":e<20?"Slow":"Very Slow";console.debug("Applying ".concat(o," update of cost ").concat(e,"/45 ")),console.debug(t)}},{key:"toJSON",value:function(){return{source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh,queryFilter:this.queryFilter}}}],[{key:"create",value:function(t){var r=new e;for(var n in t){var a=t[n];if("object"==typeof a)for(var i in a){var s=a[i];r[n][i]=s}r[n]=a}return r}},{key:"empty",value:function(){return e.create({})}},{key:"all",value:function(){return e.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}}]),e}(),j=r(9),I=r(4),w=r(30),S=r(359),F=r(791),T=r(881),C=r(323),E=r(895),A=r(903),R=r(1077),M=r(1047),q=r(32),D=r(37),L=r(304),z=r(805),P=r(278),N=r(780),U=r(386),G=r(61),B=r(55),V=r(23),Q=r(81),Y=r(384),X=r(251),H=r(46),Z=(r(408),r(332)),W=(r(362),r(882)),J=r(1075);r(968),f.a.getLogger("esri.layers.graphics.sources.ogcfeature");function K(e,t,r){return $.apply(this,arguments)}function $(){return($=Object(i.a)(a.a.mark((function e(t,r,n){var i,s,u,o,c,l,h,f,d,v,p,y,b,g,_,m,k,O,w,F,T,C,E,A,R,M,q,D,L,z,P,N,U,G;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.capabilities.query.maxRecordCount,u=t.collectionId,o=t.layerDefinition,c=t.url,l="".concat(c,"/collections/").concat(u,"/items"),h=r.geometry,f=r.num,d=r.start,v=r.timeExtent,p=r.where,y=Object(I.i)(r.outSpatialReference)?r.outSpatialReference:H.a,b=function(e){if(Object(I.h)(e))return null;var t=e.xmin,r=e.ymin,n=e.xmax,a=e.ymax;return"".concat(t,",").concat(r,",").concat(n,",").concat(a)}(Object(W.b)(h,H.a)),g=function(e){if(Object(I.h)(e))return null;var t=e.start,r=e.end;return"".concat(t?t.toISOString():"..","/").concat(r?r.toISOString():"..")}(v),a=p,_=Object(I.h)(a)||!a||"1=1"===a?null:a,m=null!=f?f:null!=d&&void 0!==d?10:s,e.next=17,Object(Q.default)(l,Object(j.a)(Object(j.a)({},n),{},{query:{bbox:b,datetime:g,query:_,limit:m,startindex:d,f:"json"}}));case 17:if(k=e.sent,O=k.data,w=null==(i=O.links)?void 0:i.filter((function(e){return"next"===e.rel})),F=0!==(null==w?void 0:w.length),T=o.fields,C=o.globalIdField,E=o.hasM,A=o.hasZ,R=o.objectIdField,M=o.geometryType,q=Object(J.a)(O,{geometryType:M,hasZ:A,objectIdFieldName:R}),!Object(H.c)(y,H.a)){D=Object(x.a)(q);try{for(D.s();!(L=D.n()).done;)(z=L.value).geometry&&(z.geometry=Object(S.d)(Object(W.b)(Object(S.k)(z.geometry,M,A,!1),H.a,y)))}catch(B){D.e(B)}finally{D.f()}}P=Object(x.a)(q);try{for(P.s();!(N=P.n()).done;)(U=N.value).objectId=U.attributes[R]}catch(B){P.e(B)}finally{P.f()}return G=new Z.a,e.abrupt("return",(G.exceededTransferLimit=F,G.features=q,G.fields=T,G.geometryType=M,G.globalIdFieldName=C,G.hasM=E,G.hasZ=A,G.objectIdFieldName=R,G.spatialReference=y||H.a,G));case 33:case"end":return e.stop()}var a}),e)})))).apply(this,arguments)}var ee=r(202),te=r(142),re=r(840),ne=r(399),ae=r(436),ie=function(){function e(){Object(s.a)(this,e),this.hasFeatures=!1,this.fieldIndexMap=new Map,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.dateFields=new Set,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}return Object(u.a)(e,[{key:"hasFieldIndex",value:function(e){return this.fieldIndexMap.has(e)}},{key:"isDateField",value:function(e){return this.dateFields.has(e)}},{key:"getFieldIndex",value:function(e){return this.fieldIndexMap.get(e)}}]),e}();function se(e){for(var t=e.getLength(),r=e.pos()+t,n={name:"",isDate:!1};e.pos()<r&&e.next();)switch(e.tag()){case 1:n.name=e.getString();break;case 2:"esriFieldTypeDate"===Object(ae.b)(e.getEnum())&&(n.isDate=!0);break;default:e.skip()}return n}var ue=f.a.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF");function oe(e){for(;e.next();)switch(e.tag()){case 1:return e.getMessage();default:e.skip()}return null}var ce=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e,n,a,i){var u;return Object(s.a)(this,r),(u=t.call(this,e))._hasNext=!1,u._isPoints=!1,u._isPolygons=!1,u._featureIndex=-1,u._featureOffset=0,u._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},u._geometryType=i,u._reader=n,u._header=a,u._hasNext=a.hasFeatures,u._isPoints="esriGeometryPoint"===i,u._isPolygons="esriGeometryPolygon"===i,u}return Object(u.a)(r,[{key:"geometryType",get:function(){return this._geometryType}},{key:"size",get:function(){return this._header.featureCount}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"stride",get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}},{key:"hasFeatures",get:function(){return this._header.hasFeatures}},{key:"hasNext",get:function(){return this._hasNext}},{key:"exceededTransferLimit",get:function(){return this._header.exceededTransferLimit}},{key:"getApproximateSize",value:function(){if(this._hasFilter){var e=Math.abs(this._xmax-this._xmin)*Math.abs(this._ymax-this._ymin),t=this.size*e/262144;return Math.max(Math.round(t),0)}return this.size}},{key:"getQuantizationTransform",value:function(){return this._header.transform}},{key:"getCursor",value:function(){return this.copy()}},{key:"getIndex",value:function(){return this._featureIndex}},{key:"setIndex",value:function(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}},{key:"getAttributeHash",value:function(){var e=this,t="";return this._header.fieldIndexMap.forEach((function(r){t+=e._readAttributeAtIndex(r)+"."})),t}},{key:"getObjectId",value:function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}},{key:"getDisplayId",value:function(){return this._header.displayIds[this._featureIndex]}},{key:"setDisplayId",value:function(e){this._header.displayIds[this._featureIndex]=e}},{key:"getGroupId",value:function(){return this._header.groupIds[this._featureIndex]}},{key:"setGroupId",value:function(e){this._header.groupIds[this._featureIndex]=e}},{key:"readLegacyFeature",value:function(){if(void 0===this._cache.legacyFeature){var e,t=this.readCentroid(),r={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(e=t&&{x:t.coords[0],y:t.coords[1]})?e:null};return this._cache.legacyFeature=r,r}return this._cache.legacyFeature}},{key:"readOptimizedFeature",value:function(){if(void 0===this._cache.optFeature){var e=new ee.a(this.readGeometry(),this.readAttributes(),this.readCentroid());return this._cache.optFeature=e,e}return this._cache.optFeature}},{key:"getXHydrate",value:function(){var e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return e*t.scale[0]+t.translate[0]}},{key:"getYHydrate",value:function(){var e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return t.translate[1]-e*t.scale[1]}},{key:"readLegacyPointGeometry",value:function(){return{x:this._header.centroid[2*this._featureIndex]+this._tx,y:this._header.centroid[2*this._featureIndex+1]+this._ty}}},{key:"readLegacyGeometry",value:function(){var e=this.readGeometry();return Object(S.k)(e,this.geometryType,!1,!1)}},{key:"readLegacyCentroid",value:function(){var e=this.readCentroid();if(!e)return null;var t=Object(q.a)(e.coords,2);return{x:t[0],y:t[1]}}},{key:"readGeometryArea",value:function(){return this._cache.area||this.readGeometry(),this._cache.area}},{key:"readUnquantizedGeometry",value:function(){if(void 0===this._cache.unquantGeometry){var e=this.readGeometry();if(!e)return this._cache.unquantGeometry=null,null;for(var t=e.clone(),r=t.lengths,n=t.coords,a=0,i=2;a<r.length;a++,i+=2)for(var s=r[a],u=1;u<s;u+=1,i+=2)n[i]+=n[i-2],n[i+1]+=n[i-1];return this._cache.unquantGeometry=t,t}return this._cache.unquantGeometry}},{key:"readHydratedGeometry",value:function(){var e=this.readGeometry();if(!e)return null;var t=e.clone();return this._isPoints&&(t.coords[0]-=this._tx,t.coords[1]-=this._ty),Object(S.y)(t,t,this.hasZ,this.hasM,this.getQuantizationTransform()),t}},{key:"readGeometry",value:function(){if(void 0===this._cache.geometry){var e=null;if(this._isPoints){var t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;e=new te.a([],[t,r])}else{var n=this._header.offsets.geometry[this._featureIndex],a=this._reader;if(0===n)return null;a.move(n);try{e=this._parseGeometry(a)}catch(fe){return console.error("Failed to parse geometry!",fe),null}}return this._cache.geometry=e,e}return this._cache.geometry}},{key:"readCentroid",value:function(){if(void 0===this._cache.centroid){var e=null,t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;return 268435455===t?(e=this._computeCentroid())&&(this._header.centroid[2*this._featureIndex]=e.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=e.coords[1]-this._ty):e=new te.a([],[t,r]),this._cache.centroid=e,e}return this._cache.centroid}},{key:"copy",value:function(){var e=this._reader.clone(),t=new r(this.instance,e,this._header,this.geometryType);return this.copyInto(t),t}},{key:"next",value:function(){if(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,!this._hasFilter)return++this._featureIndex<this.size;for(;++this._featureIndex<this.size&&!this._passesFilter(););return this._featureIndex<this.size}},{key:"_readAttribute",value:function(e,t){var r=this._header.hasFieldIndex(e)?e:function(e){return e.toLowerCase().trim()}(e),n=this._header.getFieldIndex(r);if(null!=n){var a=this._readAttributeAtIndex(n);return t&&this._header.isDateField(r)?new Date(a):a}}},{key:"_readAttributes",value:function(){var e=this,t={};return this._header.fieldIndexMap.forEach((function(r,n){t[n]=e._readAttributeAtIndex(r)})),t}},{key:"copyInto",value:function(e){Object(G.a)(Object(B.a)(r.prototype),"copyInto",this).call(this,e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext}},{key:"_passesFilter",value:function(){if(!this._hasFilter)return!0;var e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];if(268435455===e){if(this._isPolygons&&!this.readCentroid())return!1;e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1]}return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax}},{key:"_readAttributeAtIndex",value:function(e){var t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;return r.move(t),function(e){for(var t=e.getLength(),r=e.pos()+t;e.pos()<r&&e.next();)switch(e.tag()){case 1:var n=e.getString();return""===n?null:n;case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}(r)}},{key:"_preprocessPolygon",value:function(e,t){for(var r=0,n=0,a=0,i=!1,s=!1,u=!1,o=-1,c=[],l=0,h=!1,f=0;f<t.length;f++){for(var d=t[f],v=e[2*r],p=e[2*r+1],y=0,b=1;b<d;b++){var g=v,_=p,m=v+e[2*(r+b)],k=p+e[2*(r+b)+1];v=m,p=k,y+=(m-g)*(k+_)*.5}var x=y>0;if(x&&h&&(n+=d),x||(o++,h=!1),o>=1e6)break;l+=y,i&&x&&s&&(u=!0),e[2*a]=e[2*n],e[2*a+++1]=e[2*n+++1];for(var O=1,j=e[2*n],I=e[2*n+++1],w=2;w<d;w++){var S=e[2*n],F=e[2*n+++1];j*F-S*I==0?(j+=S,I+=F):(e[2*a]=j,e[2*a+++1]=I,O++,j=S,I=F)}e[2*a]=j,e[2*a+++1]=I,O++,c.push(O),i=!1,s=!0,r+=d}return c.length?(this._cache.area=Math.abs(l),new te.a(c,e,u)):null}},{key:"_parseGeometry",value:function(e){for(var t=e.getLength(),r=e.pos()+t,n=[],a=[];e.pos()<r&&e.next();)switch(e.tag()){case 2:for(var i=e.getUInt32(),s=e.pos()+i;e.pos()<s;)a.push(e.getUInt32());break;case 3:for(var u=e.getUInt32(),o=e.pos()+u;e.pos()<o;)n.push(e.getSInt32()),n.push(e.getSInt32()),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();break;case 1:default:e.skip()}for(var c=0,l=0,h=a;l<h.length;l++){var f=h[l];n[2*c]+=this._tx,n[2*c+1]+=this._ty,c+=f}return this._isPolygons?this._preprocessPolygon(n,a):new te.a(a,n)}}],[{key:"fromBuffer",value:function(e,t){var n=function(e){try{for(var t=new ne.a(new Uint8Array(e),new DataView(e));t.next();)switch(t.tag()){case 2:return oe(t.getMessage());default:t.skip()}}catch(e){var r=new V.a("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});ue.error(r)}return null}(e),a=function(e,t){for(var r=e.pos(),n=new ie,a=0,i=0,s=null,u=null,o=null,c=!1;e.next();)switch(e.tag()){case 1:s=e.getString();break;case 3:u=e.getString();break;case 12:o=e.processMessage(ae.c);break;case 9:n.exceededTransferLimit=e.getBool(),n.exceededTransferLimit&&(n.offsets.geometry=new Int32Array(8e3),n.centroid=new Int32Array(16e3));break;case 13:var l=se(e),h=l.name.toLowerCase().trim(),f=a++;n.fieldIndexMap.set(l.name,f),n.fieldIndexMap.set(h,f),l.isDate&&(n.dateFields.add(l.name),n.dateFields.add(h));break;case 15:var d=e.getLength(),v=e.pos()+d;if(!n.exceededTransferLimit){var p=n.offsets.geometry,y=n.centroid;p.push(0),y.push(268435455),y.push(268435455)}!c&&n.exceededTransferLimit&&(c=!0,n.offsets.attributes=new Uint32Array(8e3*a));for(var b=i*a;e.pos()<v&&e.next();)switch(e.tag()){case 1:c?n.offsets.attributes[b++]=e.pos():n.offsets.attributes.push(e.pos());var g=e.getLength();e.skipLen(g);break;case 2:if(t)for(var _=e.getLength(),m=e.pos()+_;e.pos()<m&&e.next();)switch(e.tag()){case 3:e.getUInt32();var k=e.getSInt32(),x=e.getSInt32();n.centroid[2*i]=k,n.centroid[2*i+1]=x;break;default:e.skip()}else{n.offsets.geometry[i]=e.pos();var O=e.getLength();e.skipLen(O)}break;case 4:for(var j=e.getLength(),I=e.pos()+j;e.pos()<I&&e.next();)switch(e.tag()){case 3:e.getUInt32();var w=e.getSInt32(),S=e.getSInt32();n.centroid[2*i]=w,n.centroid[2*i+1]=S;break;default:e.skip()}break;default:e.skip()}i++,n.hasFeatures=!0;break;default:e.skip()}var F=s||u;if(!F)throw new V.a("FeatureSet has no objectId or globalId field name");return n.featureCount=i,n.fieldCount=a,n.objectIdFieldIndex=n.getFieldIndex(F),n.transform=o,n.displayIds=new Uint32Array(n.featureCount),n.groupIds=new Uint16Array(n.featureCount),e.move(r),n}(n,"esriGeometryPoint"===t);return new r(re.a.createInstance(),n,a,t)}}]),r}(re.a),le=function(){function e(t){Object(s.a)(this,e),this.service=t}return Object(u.a)(e,[{key:"destroy",value:function(){}}]),e}();var he,fe,de=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e){var n;return Object(s.a)(this,r),(n=t.call(this,e))._portsOpen=Object(Y.c)(e.source).then((function(e){return n.client=e})),n}return Object(u.a)(r,[{key:"destroy",value:function(){this.client.close(),this.client=null}},{key:"executeQuery",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._portsOpen;case 2:return e.next=4,this.client.invoke("queryFeatures",t.toJSON(),r);case 4:return n=e.sent,e.abrupt("return",T.a.fromFeatureSet(n,this.service.objectIdField));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(le),ve=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(){return Object(s.a)(this,r),t.apply(this,arguments)}return Object(u.a)(r,[{key:"executeQuery",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(X.executeQueryPBFBuffer)(this.service.source,t,Object(j.a)(Object(j.a)({},r),{},{query:Object(j.a)(Object(j.a)({},this.service.customParameters),null==r?void 0:r.query)}));case 2:return n=e.sent,i=n.data,e.abrupt("return",ce.fromBuffer(i,this.service.geometryType));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(le),pe=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(){return Object(s.a)(this,r),t.apply(this,arguments)}return Object(u.a)(r,[{key:"executeQuery",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s,u,o,c,l,h,f,d,v;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.service,i=n.source,s=n.capabilities,u=n.spatialReference,o=n.objectIdField,!t.quantizationParameters||s.query.supportsQuantization){e.next=10;break}return(c=t.clone()).quantizationParameters=null,e.next=6,Object(X.executeQuery)(i,c,u,Object(j.a)(Object(j.a)({},r),{},{query:Object(j.a)(Object(j.a)({},this.service.customParameters),null==r?void 0:r.query)}));case 6:return l=e.sent,h=l.data,f=Object(S.b)(h,o),e.abrupt("return",(Object(S.t)(r.transform,f),T.a.fromOptimizedFeatureSet(f)));case 10:return e.next=12,Object(X.executeQuery)(i,t,this.service.spatialReference,Object(j.a)(Object(j.a)({},r),{},{query:Object(j.a)(Object(j.a)({},Object(I.o)(this.service.customParameters)),null==r?void 0:r.query)}));case 12:return d=e.sent,v=d.data,e.abrupt("return",T.a.fromFeatureSet(v,this.service.objectIdField));case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(le),ye=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(){return Object(s.a)(this,r),t.apply(this,arguments)}return Object(u.a)(r,[{key:"executeQuery",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.service.capabilities,!t.quantizationParameters||n.query.supportsQuantization){e.next=7;break}return t.clone().quantizationParameters=null,e.next=5,K(this.service.source,t,r);case 5:return i=e.sent,e.abrupt("return",(Object(S.t)(r.transform,i),T.a.fromOptimizedFeatureSet(i)));case 7:return e.next=9,K(this.service.source,t,r);case 9:return s=e.sent,e.abrupt("return",T.a.fromOptimizedFeatureSet(s));case 11:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(le),be=r(76),ge=function(){function e(t){Object(s.a)(this,e),this._abortController=new AbortController,this.requests={pending:new Array,done:new Array},this.tile=t}return Object(u.a)(e,[{key:"signal",get:function(){return this._abortController.signal}},{key:"add",value:function(e){this.requests.done.push(e),e.request.end&&(this.resolved=!0)}},{key:"abort",value:function(){this._abortController.abort()}}]),e}(),_e=function(){function e(t){Object(s.a)(this,e),this.events=new be.a,this._subscriptions=new Map,this._serviceQueryInfo={outSpatialReference:t.outSR},this._serviceInfo=t.serviceInfo,this._onRequest=t.onRequest}return Object(u.a)(e,[{key:"queryLastEditDate",value:function(){var e=Object(i.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Service does not support query type");case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"query",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Service does not support query");case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"geometryType",get:function(){return this._serviceInfo.geometryType}},{key:"update",value:function(e){Object(z.a)(e,this._sourceQueryInfo)&&(this._sourceQueryInfo=e)}},{key:"updateSubscriptions",value:function(){}},{key:"setViewState",value:function(e){}},{key:"subscribe",value:function(e){var t=new ge(e);this._subscriptions.set(e.id,t)}},{key:"unsubscribe",value:function(e){var t=this.get(e.id);Object(I.i)(t)&&t.abort(),this._subscriptions.delete(e.id)}},{key:"pause",value:function(){}},{key:"resume",value:function(){}},{key:"get",value:function(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null}},{key:"enableEvent",value:function(e,t){}}]),e}(),me=f.a.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource"),ke=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e){var n;return Object(s.a)(this,r),(n=t.call(this,e)).type="feature",n._adapter=function(e){var t,r=e.capabilities;return(t=e.source)&&t.capabilities&&t.collectionId&&t.layerDefinition&&t.url?new ye(e):function(e){return Array.isArray(e.source)}(e)?new de(e):r.query.supportsFormatPBF?new ve(e):new pe(e)}(e.serviceInfo),n._queue=new C.a({concurrency:8,process:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,i,s,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Object(p.w)(t),r=t.tile.key.id,i=t.tile,s=t.signal,u={query:Object(h.a)("esri-tiles-debug")?{tile:r.replace(/\//g,"."),depth:t.depth}:void 0,signal:s,transform:i.transform},e.abrupt("return",n._adapter.executeQuery(t.query,u));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}),n._patchQueue=new C.a({concurrency:8,process:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,i,s,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Object(p.w)(t),r=t.tile.key.id,i=t.tile,s=t.signal,u={query:Object(h.a)("esri-tiles-debug")?{tile:r.replace(/\//g,"."),depth:t.depth}:void 0,signal:s,transform:i.transform},e.abrupt("return",n._adapter.executeQuery(t.query,u));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}),n}return Object(u.a)(r,[{key:"destroy",value:function(){this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}},{key:"setViewState",value:function(e){}},{key:"updating",get:function(){return!!this._queue.length}},{key:"subscribe",value:function(e){Object(G.a)(Object(B.a)(r.prototype),"subscribe",this).call(this,e),this._fetchDataTile(e).catch((function(t){Object(p.n)(t)||me.error(new V.a("mapview-query-error","Encountered error when fetching tile",{tile:e,error:t}))}))}},{key:"unsubscribe",value:function(e){Object(G.a)(Object(B.a)(r.prototype),"unsubscribe",this).call(this,e)}},{key:"pause",value:function(){this._queue.pause()}},{key:"resume",value:function(){this._queue.resume()}},{key:"query",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._adapter.executeQuery(t,r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryLastEditDate",value:function(){var e=Object(i.a)(a.a.mark((function e(){var t,r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._serviceInfo.source,r=Object(j.a)(Object(j.a)({},t.query),{},{f:"json"}),e.next=3,Object(Q.default)(t.path,{query:r,responseType:"json"});case 3:return e.abrupt("return",e.sent.data.editingInfo.lastEditDate);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"forEachRequest",value:function(e,t){var r,n=this._subscriptions.get(e),a=n.requests,i=n.signal,s=Object(x.a)(a.done);try{for(s.s();!(r=s.n()).done;){t(r.value.request,{signal:i})}}catch(u){s.e(u)}finally{s.f()}}},{key:"_executePatchQuery",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n,i){var s,u,o;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(s=r.clone()).outFields=[this._serviceInfo.objectIdField].concat(Object(D.a)(n)),s.returnCentroid=!1,s.returnGeometry=!1,u=Object(I.i)(s.start)?s.start/8e3:0,o=i.signal,e.abrupt("return",this._patchQueue.push({tile:t,query:s,signal:o,depth:u}));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"_resendRequest",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s,u,o,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.query,i=t.request,s=Object(I.i)(n.outFields)?n.outFields:[],u=this._sourceQueryInfo.outFields,o=u.filter((function(e){return-1===s.indexOf(e)})),Object(I.h)(i.features)){e.next=15;break}if(!o.length){e.next=14;break}return e.prev=3,e.next=6,this._executePatchQuery(i.tile,n,o,r);case 6:c=e.sent,Object(p.w)(r),n.outFields=u,i.features.joinAttributes(c),this._onRequest(Object(j.a)(Object(j.a)({},i),{},{end:i.end||r.end}),"new",r),e.next=12;break;case 10:e.prev=10,e.t0=e.catch(3);case 12:e.next=15;break;case 14:this._onRequest(Object(j.a)(Object(j.a)({},i),{},{end:i.end||r.end}),"new",r);case 15:case"end":return e.stop()}}),e,this,[[3,10]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"resend",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,u=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(r=t.dataTileOnly,n=0,i=!1,s=[],this._subscriptions.forEach((function(e){if(!e.requests.done.length){var t=e.tile;u._onRequest({tile:t,id:t.id,features:null,noData:!0,end:!1},"new",{dataTileOnly:!0})}}));!i;)i=!0,this._subscriptions.forEach((function(e){var t=e.requests,a=e.signal;if(t.done.length>n){i=!1;var o=t.done.length===n+1;s.push(u._resendRequest(t.done[n],{signal:a,dataTileOnly:r,end:o}))}})),n++;return e.next=6,Object(p.b)(s);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createQuery",value:function(e,t){var r=new P.a(Object(j.a)(Object(j.a)(Object(j.a)({},this._serviceQueryInfo),this._sourceQueryInfo),t));return this._serviceInfo.capabilities.query.supportsQuantization||(t.quantizationParameters=null,r.maxAllowableOffset=e.resolution),t.quantizationParameters&&"esriGeometryPolyline"===this.geometryType&&(r.maxAllowableOffset=e.resolution),r.resultType="tile",r.geometry=e.extent,r}}]),r}(_e),xe=Object(h.a)("esri-featurelayer-webgl"),Oe=Object(h.a)("esri-mobile"),je={maxDrillLevel:xe&&"object"==typeof xe&&null!=xe.maxDrillLevel?xe.maxDrillLevel:Oe?1:4,maxRecordCountFactor:xe&&"object"==typeof xe&&null!=xe.maxRecordCountFactor?xe.maxRecordCountFactor:Oe?1:3},Ie=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e){return Object(s.a)(this,r),t.call(this,e)}return Object(u.a)(r,[{key:"_fetchDataTile",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,s,u,o,c,l=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,n=this._subscriptions.get(t.key.id),s=n.signal,u=t.getQuantizationParameters(),o=0,(c=function(){var e=Object(i.a)(a.a.mark((function e(i,h){var f,d,v,y,b,g,_;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return f=l._sourceQueryInfo,d=l._createQuery(i,{maxRecordCountFactor:r?je.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:u}),o++,e.prev=2,e.next=5,l._queue.push({tile:t,query:d,signal:s,depth:h});case 5:if(v=e.sent,o--,Object(p.w)(s),v){e.next=8;break}return e.abrupt("return");case 8:if(f===l._sourceQueryInfo){e.next=10;break}return e.abrupt("return",void c(i,h));case 10:if(!(v.exceededTransferLimit&&h<je.maxDrillLevel)){e.next=14;break}y=Object(x.a)(i.createChildTiles());try{for(y.s();!(b=y.n()).done;)g=b.value,c(g,h+1)}catch(a){y.e(a)}finally{y.f()}return e.abrupt("return");case 14:_={tile:t,id:t.id,features:v,end:0===o},n.requests.done.push({query:d,request:_}),l._onRequest(_,"new"),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(2),Object(p.n)(e.t0)||l._onRequest({tile:t,id:t.id,features:null,end:!0},"new");case 21:case"end":return e.stop()}}),e,null,[[2,18]])})));return function(t,r){return e.apply(this,arguments)}}())(t,0);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(ke),we=r(34),Se=r(857),Fe=r(39),Te=r(878),Ce=function(){function e(t,r,n,a){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:128;Object(s.a)(this,e),this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=n,this._purgeOptions=a,this.store=t,this.objectIdField=r,this.purgeInterval=i,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}return Object(u.a)(e,[{key:"add",value:function(e){if(this._useGeneratedIds){var t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),this._timeInfo.trackIdField){var r=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(r)){var n=Object(I.i)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,a=Object(Fe.c)(n,0,1e3);this._trackIdToObservations.set(r,new Te.a(a))}var i=this._trackIdToObservations.get(r).enqueue(e.objectId);Object(I.i)(i)&&(this._addOrUpdated.has(i)?this._addOrUpdated.delete(i):this._removed.push(i))}}},{key:"checkForUpdates",value:function(){var e=this._getToAdd(),t=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);var n=[];if(Object(I.i)(t)){var a,i=Object(x.a)(t);try{for(i.s();!(a=i.n()).done;){var s=a.value,u=this.store.removeById(s);Object(I.i)(u)&&n.push(u)}}catch(h){i.e(h)}finally{i.f()}}if(Object(I.i)(e)){var o,c=Object(x.a)(e);try{for(c.s();!(o=c.n()).done;){var l=o.value;l.attributes.__esri_timestamp__=r,this.store.add(l)}}catch(h){c.e(h)}finally{c.f()}}(e||n)&&this.store.update(e,n)}},{key:"_getToAdd",value:function(){if(!this._addOrUpdated.size)return null;var e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach((function(r){return e[t++]=r})),this._addOrUpdated.clear(),e}},{key:"_getToRemove",value:function(){var e=this._removed;return this._removed.length?(this._removed=[],e):null}},{key:"_nextId",value:function(){var e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}},{key:"_purge",value:function(e){var t=this._purgeOptions;Object(I.i)(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}},{key:"_purgeSomeByDisplayCount",value:function(e){var t=this;if(e.displayCount){var r=this.store.size;r>e.displayCount&&this._trackIdToObservations.forEach((function(n){if(r>e.displayCount&&n.size){var a=Object(I.o)(n.dequeue());t._removed.push(a),r--}}))}}},{key:"_purgeByAge",value:function(e){var t,r=this;if(e.age&&null!=(t=this._timeInfo)&&t.startTimeField){var n=60*e.age*1e3,a=this._maxAge-n;this.store.forEach((function(e){e.attributes[r._timeInfo.startTimeField]<a&&r._removed.push(e.objectId)}))}}},{key:"_purgeByAgeReceived",value:function(e,t){var r=this;if(t.ageReceived){var n=e+60*t.ageReceived*1e3;this.store.forEach((function(e){e.attributes.__esri_timestamp__<n&&r._removed.push(e.objectId)}))}}},{key:"_purgeTracks",value:function(){var e=this;this._trackIdToObservations.forEach((function(t,r){0===t.size&&e._trackIdToObservations.delete(r)}))}}]),e}(),Ee=r(311),Ae=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(){return Object(s.a)(this,r),t.apply(this,arguments)}return Object(u.a)(r,[{key:"onFeature",value:function(e){this.emit("feature",e)}}]),r}(be.a.EventedMixin(y.a)),Re=Ae=Object(l.a)([Object(v.a)("esri.layers.graphics.sources.connections.StreamConnection")],Ae),Me=f.a.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");(fe=he||(he={}))[fe.CONNECTING=0]="CONNECTING",fe[fe.OPEN=1]="OPEN",fe[fe.CLOSING=2]="CLOSING",fe[fe.CLOSED=3]="CLOSED";var qe=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e){var n;Object(s.a)(this,r),(n=t.call(this)).errorString=null;var a=e.geometryType,i=e.spatialReference,u=e.sourceSpatialReference;return n._config=e,n._featureZScaler=Object(Ee.a)(a,u,i),n._open(),n}return Object(u.a)(r,[{key:"_open",value:function(){var e=Object(i.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tryCreateWebSocket();case 2:if(e.t0=this.destroyed,e.t0){e.next=6;break}return e.next=6,this._handshake();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){Object(I.i)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if(Object(I.h)(this._websocket))return"disconnected";switch(this._websocket.readyState){case he.CONNECTING:case he.OPEN:return"connected";case he.CLOSING:case he.CLOSED:return"disconnected"}}},{key:"_tryCreateWebSocket",value:function(){var e=Object(i.a)(a.a.mark((function e(){var t,r,n,i,s=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=s.length>0&&void 0!==s[0]?s[0]:this._config.source.path,r=s.length>1&&void 0!==s[1]?s[1]:1e3,n=s.length>2&&void 0!==s[2]?s[2]:0,e.prev=3,!this.destroyed){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,this._createWebSocket(t);case 8:this._websocket=e.sent,this.notifyChange("connectionStatus"),e.next=24;break;case 12:if(e.prev=12,e.t0=e.catch(3),i=r/1e3,!(this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts)){e.next=19;break}e.t1=(Me.error(new V.a("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()),e.next=23;break;case 19:return Me.error(new V.a("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(i,"s"),e.t0)),e.next=22,Object(p.a)(r);case 22:e.t1=this._tryCreateWebSocket(t,Math.min(1.5*r,1e3*this._config.maxReconnectionInterval),n+1);case 23:return e.abrupt("return",e.t1);case 24:case"end":return e.stop()}}),e,this,[[3,12]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createWebSocket",value:function(e){var t=this,r=new WebSocket(e),n=Object(p.c)((function(e,t){r.onopen=function(){return e(r)},r.onclose=function(e){return t(e)}}));return n.then((function(){if(t.destroyed)return r.onclose=function(){},void r.close();r.onclose=function(e){return t._onClose(e)},r.onerror=function(e){return t._onError(e)},r.onmessage=function(e){return t._onMessage(e)}})),n}},{key:"_handshake",value:function(){var e=Object(i.a)(a.a.mark((function e(){var t,r,n,i,s,u,o,c,l=this,h=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=h.length>0&&void 0!==h[0]?h[0]:1e4,r=this._websocket,!Object(I.h)(r)){e.next=4;break}return e.abrupt("return");case 4:return n=Object(p.g)(),i=r.onmessage,s=this._config,u=s.filter,o=s.outFields,c=s.spatialReference,e.abrupt("return",(n.timeout(t),r.onmessage=function(e){var t,a=null;try{a=JSON.parse(e.data)}catch(e){}a&&"object"==typeof a||(Me.error(new V.a("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),n.reject(),l.destroy()),(null==(t=a.spatialReference)?void 0:t.wkid)!==(null==c?void 0:c.wkid)&&(Me.error(new V.a("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(c.wkid),e.data)),n.reject(),l.destroy()),"json"!==a.format&&(Me.error(new V.a("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),n.reject(),l.destroy()),u&&a.filter!==u&&Me.error(new V.a("websocket-connection","Tried to set filter, but server doesn't support it")),o&&a.outFields!==o&&Me.error(new V.a("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=i,n.resolve()},r.send(JSON.stringify({filter:u,outFields:o,format:"json",spatialReference:{wkid:c.wkid}})),n.promise));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){try{var t=JSON.parse(e.data);if("featureResult"!==t.type)throw new V.a("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);var r,n=Object(x.a)(t.features);try{for(n.s();!(r=n.n()).done;){var a=r.value;this._featureZScaler&&this._featureZScaler(a.geometry),this.onFeature(a)}}catch(i){n.e(i)}finally{n.f()}}catch(e){return Me.error(new V.a("websocket-connection","Failed to parse message",e)),void this.destroy()}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),Me.error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&Me.error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),r}(Re);Object(l.a)([Object(d.b)()],qe.prototype,"connectionStatus",null),Object(l.a)([Object(d.b)()],qe.prototype,"errorString",void 0),qe=Object(l.a)([Object(v.a)("esri.layers.graphics.sources.connections.WebSocketConnection")],qe);var De=r(44),Le=r(58),ze=(r(77),f.a.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection")),Pe={maxQueryDepth:5,maxRecordCountFactor:3},Ne=function(e){Object(o.a)(n,e);var t=Object(c.a)(n);function n(e){return Object(s.a)(this,n),t.call(this,Object(j.a)(Object(j.a)({},Pe),e))}return Object(u.a)(n,[{key:"_open",value:function(){var e=Object(i.a)(a.a.mark((function e(){var t,r,n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchServiceDefinition(this._config.source);case 2:return(t=e.sent).timeInfo.trackIdField||ze.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),e.next=6,this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference);case 6:return r=e.sent,this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),e.next=10,this._buddyServicesQuery;case 10:return e.next=12,this._tryCreateWebSocket(r);case 12:n=this._config,i=n.filter,s=n.outFields,this.destroyed||this._setFilter(i,s);case 14:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){var t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(e){return void ze.error(new V.a("geoevent-connection","Failed to parse message",e))}this.onFeature(t)}},{key:"_fetchServiceDefinition",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Object(Q.default)(t.path,{query:{f:"json"},responseType:"json"}),e.next=3,r;case 3:return n=e.sent.data,e.abrupt("return",(this._serviceDefinition=n,n));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchWebSocketUrl",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t[0],i=n.urls,s=n.token,e.abrupt("return","".concat(this._inferWebSocketBaseUrl(i),"/subscribe?outSR=").concat(r.wkid).concat(s?"&token="+s:""));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t,r=Object(x.a)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(-1!==n.indexOf("wss"))return n}}catch(a){r.e(a)}finally{r.f()}return ze.error(new V.a("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s,u,o=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._websocket,!(Object(I.h)(n)||Object(I.h)(t)&&Object(I.h)(r))){e.next=3;break}return e.abrupt("return");case 3:return i=JSON.stringify({filter:this._serializeFilter(t,r)}),s=!1,u=Object(p.g)(),e.abrupt("return",(n.onmessage=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(ze.error(new V.a("geoevent-connection","Failed to set service filter",t.error)),o._set("errorString","Could not set service filter - ".concat(t.error)),u.reject(t.error)),n.onmessage=o._onMessage.bind(o),s=!0,u.resolve())},n.send(i),setTimeout((function(){s||(o.destroyed||o._websocket!==n||ze.error(new V.a("geoevent-connection","Server timed out when setting filter")),u.reject())}),1e4),u.promise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_serializeFilter",value:function(e,t){var r={};if(Object(I.h)(e)&&Object(I.h)(t))return r;if(Object(I.i)(e)&&e.geometry)try{var n=Object(Le.a)(e.geometry);if("extent"!==n.type)throw new V.a("Expected extent but found type ".concat(n.type));r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(e){ze.error(new V.a("geoevent-connection","Encountered an error when setting connection geometryDefinition",e))}return Object(I.i)(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),Object(I.i)(t)&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return ze.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),a=n.attributes,i=n.geometry;for(var s in a)e.attributes[s]=a[s];return i&&(e.geometry=i),e.geometry||e.centroid||ze.error(new V.a("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var e=Object(i.a)(a.a.mark((function e(){var t,r,n,i,s,u,o,c,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._serviceDefinition,r=t.relatedFeatures,n=t.keepLatestArchive,i=this._queryRelatedFeatures(r),s=this._queryArchive(n),e.next=4,i;case 4:return e.next=6,s;case 6:if(u=e.sent){e.next=9;break}return e.abrupt("return");case 9:o=Object(x.a)(u.features);try{for(o.s();!(c=o.n()).done;)l=c.value,this.onFeature(this._enrich(l))}catch(a){o.e(a)}finally{o.f()}e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),ze.error(new V.a("geoevent-connection","Encountered an error when querying buddy services",{error:e.t0}));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRelatedFeatures",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._queryBuddy(t.featuresUrl);case 4:r=e.sent,this._addRelatedFeatures(r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryArchive",value:function(){var e=Object(i.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",this._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryBuddy",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var n,i,s,u,o,c,l,h,f,d,v;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([r.e(3),r.e(5),r.e(4),r.e(6),r.e(65)]).then(r.bind(null,827));case 2:return e.t0=e.sent.default,e.t1={url:t},n=new e.t0(e.t1),e.next=7,n.load();case 7:if(i=e.sent,s=i.capabilities,u=s.query.supportsMaxRecordCountFactor,o=s.query.supportsPagination,c=s.query.supportsCentroid,l=this._config.maxRecordCountFactor,h=n.capabilities.query.maxRecordCount,f=u?h*l:h,(d=new P.a).outFields=Object(I.p)(this._config.outFields,["*"]),d.where=Object(I.p)(Object(I.g)(this._config.filter,"where"),"1=1"),d.returnGeometry=!0,d.returnExceededLimitFeatures=!0,d.outSpatialReference=De.a.fromJSON(this._config.spatialReference),c&&(d.returnCentroid=!0),u&&(d.maxRecordCountFactor=l),!o){e.next=18;break}return e.abrupt("return",(d.num=f,n.destroy(),this._queryPages(t,d)));case 18:return e.next=20,Object(X.executeQuery)(t,d,this._config.sourceSpatialReference);case 20:return v=e.sent,e.abrupt("return",(n.destroy(),v.data));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryPages",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s,u,o=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>2&&void 0!==o[2]?o[2]:[],i=o.length>3&&void 0!==o[3]?o[3]:0,r.start=Object(I.i)(r.num)?i*r.num:null,e.next=5,Object(X.executeQuery)(t,r,this._config.sourceSpatialReference);case 5:return s=e.sent,u=s.data,e.abrupt("return",u.exceededTransferLimit&&i<this._config.maxQueryDepth?(u.features.forEach((function(e){return n.push(e)})),this._queryPages(t,r,n,i+1)):(n.forEach((function(e){return u.features.push(e)})),u));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addRelatedFeatures",value:function(e){var t,r=new Map,n=e.features,a=this._serviceDefinition.relatedFeatures.joinField,i=Object(x.a)(n);try{for(i.s();!(t=i.n()).done;){var s=t.value,u=s.attributes[a];r.set(u,s)}}catch(o){i.e(o)}finally{i.f()}this._relatedFeatures=r}}]),n}(qe),Ue=Ne=Object(l.a)([Object(v.a)("esri.layers.graphics.sources.connections.GeoEventConnection")],Ne);function Ge(e,t){var r=e.weakClone(),n=Object(S.v)(t,e.geometry.coords[0]),a=Object(S.w)(t,e.geometry.coords[1]);return r.geometry=new te.a([],[n,a]),r}function Be(e,t){var r=Object(Se.a)(9,function(e){switch(e){case"esriGeometryPoint":return function(e){return{minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]}};default:return function(e){var t=1/0,r=1/0,n=-1/0,a=-1/0;return e.geometry.forEachVertex((function(e,i){t=Math.min(t,e),r=Math.min(r,i),n=Math.max(n,e),a=Math.max(a,i)})),{minX:t,minY:r,maxX:n,maxY:a}}}}(t));return r.load(e),r}function Ve(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}var Qe=function(){function e(t,r){Object(s.a)(this,e),this.onUpdate=t,this._geometryType=r,this._objectIdToFeature=new Map}return Object(u.a)(e,[{key:"_features",get:function(){var e=[];return this._objectIdToFeature.forEach((function(t){return e.push(t)})),e}},{key:"add",value:function(e){this._objectIdToFeature.set(e.objectId,e),this._index=null}},{key:"get",value:function(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null}},{key:"forEach",value:function(e){this._objectIdToFeature.forEach(e)}},{key:"search",value:function(e){return this._index||(this._index=Be(this._features,this._geometryType)),Ve(this._index,e)}},{key:"removeById",value:function(e){var t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null}},{key:"update",value:function(e,t){this.onUpdate(e,t)}},{key:"size",get:function(){return this._objectIdToFeature.size}}]),e}(),Ye=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e){var n;Object(s.a)(this,r),(n=t.call(this,e)).type="geoevent",n._dataReceiveEventEnabled=!1,n._updateInfo={websocket:0,client:0};var a=e.outSR,i=e.serviceInfo,u=i.geometryType,o=i.objectIdField,c=i.timeInfo,l=i.purgeOptions,h=i.source,f=i.spatialReference,d=i.serviceFilter,v=i.maxReconnectionAttempts,p=i.maxReconnectionInterval,y=i.updateInterval,b=new Qe(n._onUpdate.bind(Object(we.a)(n)),u),g=new Ce(b,o,c,l),_=function(e,t,r,n,a,i,s){var u=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),o={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:a,maxReconnectionAttempts:i,maxReconnectionInterval:s};return u?new qe(o):new Ue(o)}(h,f,a,u,d,v,p);n._store=b,n._manager=g,n._connection=_,n._quantize=function(e){switch(e){case"esriGeometryPoint":return Ge;case"esriGeometryPolygon":case"esriGeometryPolyline":default:return function(t,r){var n=t.weakClone(),a=new te.a,i=Object(S.u)(a,t.geometry,!1,!1,e,r,!1,!1);return n.geometry=i,n}}}(u),n._handles=[n._connection.on("feature",(function(e){return n._onFeature(e)})),n._connection.watch("connectionStatus",(function(e){return n.events.emit("connectionStatus",e)})),n._connection.watch("errorString",(function(e){return n.events.emit("errorString",e)}))];var m=performance.now();return n._updateIntervalId=setInterval((function(){var t=performance.now(),r=t-m;if(r>2500){m=t;var a=Math.round(n._updateInfo.client/(r/1e3)),i=Math.round(n._updateInfo.websocket/(r/1e3));n._updateInfo.client=0,n._updateInfo.websocket=0,n.events.emit("updateRate",{client:a,websocket:i})}e.canAcceptRequest()&&n._manager.checkForUpdates()}),y),n}return Object(u.a)(r,[{key:"destroy",value:function(){clearInterval(this._updateIntervalId),this._handles.forEach((function(e){return e.remove()})),this._connection.destroy()}},{key:"_fetchDataTile",value:function(){}},{key:"enableEvent",value:function(e,t){"data-received"===e&&(this._dataReceiveEventEnabled=t)}},{key:"updating",get:function(){return!1}},{key:"subscribe",value:function(e){Object(G.a)(Object(B.a)(r.prototype),"subscribe",this).call(this,e);var t=this._getTileFeatures(e);this._onRequest({tile:e,id:e.key.id,features:t,end:!0},"new")}},{key:"unsubscribe",value:function(e){Object(G.a)(Object(B.a)(r.prototype),"unsubscribe",this).call(this,e)}},{key:"forEachRequest",value:function(e,t){var r=this._subscriptions.get(e),n=r.tile,a=r.signal;t({tile:n,id:e,features:this._getTileFeatures(n),end:!0},{signal:a})}},{key:"resend",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._subscriptions.forEach((function(e){var n=e.tile,a={tile:n,id:n.id,features:r._getTileFeatures(n),end:!0};r._onRequest(a,"update",t)}));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getTileFeatures",value:function(e){var t=this,r=this._store.search(e).map((function(r){return t._quantize(r,e.transform)}));return T.a.fromOptimizedFeatures(r,this.geometryType,e.transform)}},{key:"_onFeature",value:function(e){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",e);var t=Object(S.a)(e,this.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(e){}}},{key:"_onUpdate",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Object(I.a)(t,(function(e){return Be(e,s.geometryType)})),i=Object(I.a)(r,(function(e){return Be(e,s.geometryType)})),Object(I.i)(t)&&(this._updateInfo.client+=t.length),this._subscriptions.forEach((function(e,t){var r=e.tile,a=Object(I.a)(n,(function(e){return Ve(e,r)})),u=Object(I.a)(a,(function(e){return e.map((function(e){return s._quantize(e,r.transform)}))})),o=Object(I.a)(u,(function(e){return T.a.fromOptimizedFeatures(e,s.geometryType,r.transform)})),c=Object(I.a)(i,(function(e){return Ve(e,r)})),l=Object(I.a)(c,(function(e){return e.map((function(e){return e.objectId}))}));s._onRequest({tile:r,id:t,features:o,remove:Object(I.p)(l,[]),end:!0},"update")}));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(_e),Xe=f.a.getLogger("esri.views.2d.layers.features.sources.FeatureSource"),He=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e){return Object(s.a)(this,r),t.call(this,e)}return Object(u.a)(r,[{key:"_fetchDataTile",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,u,o,c,l,h,f,d=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this._subscriptions.get(t.key.id),n=!1,i=0,s=0,u=function(e,a){s--,Object(p.w)(r);var i=e.reader,u=e.query;if(!i.exceededTransferLimit){if(n=!0,0!==a&&!i.hasFeatures){var o={tile:t,id:t.id,features:i,end:0===s};return r.requests.done.push({request:o,query:u}),void d._onRequest(o,"new")}var c={tile:t,id:t.id,features:i,end:0===s};return r.requests.done.push({request:c,query:u}),void d._onRequest(c,"new")}var l={tile:t,id:t.id,features:i,end:n&&0===s};r.requests.done.push({request:l,query:u}),d._onRequest(l,"new")},o=0,c=0;case 4:if(n||!(c++<20)){e.next=14;break}for(l=void 0,h=function(e){var a=i++;s++,l=d._fetchDataTilePage(t,a,r).then((function(e){return e&&u(e,a)})).catch((function(e){n=!0,Object(p.n)(e)||(Xe.error(new V.a("mapview-query-error","Encountered error when fetching tile",{tile:t,error:e})),d._onRequest({tile:t,id:t.id,features:null,end:n},"new"))}))},f=0;f<o+1;f++)h();return e.next=10,l;case 10:Object(p.w)(r),o=Math.min(o+2,6);case 12:e.next=4;break;case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchDataTilePage",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n){var i,s,u,o;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._sourceQueryInfo,s=this._createQuery(t,{start:8e3*r,num:8e3,maxRecordCountFactor:3,returnExceededLimitFeatures:!0,quantizationParameters:t.getQuantizationParameters()}),e.prev=1,u=n.signal,e.next=5,this._queue.push({tile:t,query:s,signal:u,depth:r});case 5:return o=e.sent,e.abrupt("return",(Object(p.w)(n),o?i!==this._sourceQueryInfo?this._fetchDataTilePage(t,r,n):{reader:o,query:s}:null));case 9:return e.prev=9,e.t0=e.catch(1),e.abrupt("return",(Object(p.x)(e.t0),null));case 12:case"end":return e.stop()}}),e,this,[[1,9]])})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(ke);var Ze=r(896);function We(e,t,r){var n=function(e,t,r){var n=e.clone(),a=1<<n.level,i=n.col+t,s=n.row+r;return i<0&&i!==n.col?(n.col=i+a,n.world-=1):i>=a?(n.col=i-a,n.world+=1):n.col=i,n.row=s,n}(e.key,t,r);return new Ze.a(e.tileInfoView,n)}var Je=0,Ke=function(){function e(t,r){Object(s.a)(this,e),this.didSend=!1,this.dataTileCount=0,this.update=O.all(),this._abortController=new AbortController,this.invalid=!1,this.displayTile=t,this._pixelBuffer=r,this.partitions=et(t,r)}return Object(u.a)(e,[{key:"setUpdate",value:function(e,t){this.update=e,this.dataTileCount=0,t!==this._pixelBuffer&&(this._pixelBuffer=t,this.partitions=et(this.displayTile,t)),e.mesh&&(this.didSend=!1)}},{key:"signal",get:function(){return this._abortController.signal}},{key:"abort",value:function(){this._abortController.abort()}}]),e}(),$e=function(){function e(t,r,n){Object(s.a)(this,e),this.resolved=!1,this.tile=r,this.offset=t,this.extent=n}return Object(u.a)(e,[{key:"reset",value:function(){this.resolved=!1}}]),e}();function et(e,t){var r=[];if(r.push(new $e([0,0],e,null)),0===t)return r;var n=Math.min(t,N.F),a=N.F;return r.push(new $e([-a,-a],We(e,-1,-1),[a-n,a-n,a,a])),r.push(new $e([0,-a],We(e,0,-1),[0,a-n,a,a])),r.push(new $e([a,-a],We(e,1,-1),[0,a-n,n,a])),r.push(new $e([-a,0],We(e,-1,0),[a-n,0,a,a])),r.push(new $e([a,0],We(e,1,0),[0,0,n,a])),r.push(new $e([-a,a],We(e,-1,1),[a-n,0,a,n])),r.push(new $e([0,a],We(e,0,1),[0,0,a,n])),r.push(new $e([a,a],We(e,1,1),[0,0,n,n])),r}var tt=function(){function e(t,r,n){var a=this;Object(s.a)(this,e),this.type="remote",this._pendingEdits=new Set,this._queryInfo=null,this._subscriptions={display:new Map},this._invalid={outFields:!1,queryFilterParameters:!1};var i=this._onDataTileRequest.bind(this);this._source=function(e,t,r,n,a){var i=function(e,t,r,n,a){switch(e.type){case"stream":return{type:"geoevent",serviceInfo:e,onRequest:n,outSR:t,canAcceptRequest:a};case"memory":case"on-demand":return{type:"feature",serviceInfo:e,onRequest:n,outSR:t,origin:function(e){return Array.isArray(e)?"local":"path"in e&&Object(U.c)(e.path)?"hosted":"unknown"}(e.source),tileInfoView:r,canAcceptRequest:a}}}(e,t,r,n,a);switch(i.type){case"feature":switch(i.origin){case"hosted":case"local":return new He(i);case"unknown":return new Ie(i)}case"geoevent":return new Ye(i)}}(t,r,n,i,(function(){return a.canAcceptPatch()})),this._serviceInfo=t,this._geometryType=t.geometryType,this._outSR=r}return Object(u.a)(e,[{key:"destroy",value:function(){var e=this;this._getSubscriptions().map((function(t){var r=t.displayTile;return e.unsubscribe(r)})),this._source.destroy()}},{key:"updating",get:function(){return this._source.updating||this._getSubscriptions().some((function(e){return!e.didSend}))}},{key:"isStream",get:function(){return"geoevent"===this._source.type}},{key:"sourceEvents",get:function(){return"geoevent"===this._source.type?{type:"geoevent",events:this._source.events}:{type:"feature",events:this._source.events}}},{key:"enableEvent",value:function(e,t){this._source.enableEvent(e,t)}},{key:"setViewState",value:function(e){this._source.setViewState(e)}},{key:"update",value:function(e,t){var r,n,a,i,s=this._serviceInfo.fields.length,u=null!=(r=null==(n=this._schema)?void 0:n.outFields)?r:[],o=null!=(a=null==(i=this._schema)?void 0:i.pixelBuffer)?a:0,c=t.outFields.filter((function(e){return-1===u.indexOf(e)})),l=[].concat(Object(D.a)(u),Object(D.a)(c)),f=0===t.pixelBuffer?0:Math.max(t.pixelBuffer,o);t.pixelBuffer=f,t.outFields=l.length>=.75*s?["*"]:l,t.outFields.sort();var d=Object(z.a)(this._schema,t);if(this._subscriptions.display.forEach((function(t){t.invalid&&(e.queryFilter=!0)})),d){var v=this._schema&&Object(z.b)(d,"outFields"),p=this._schema&&Object(z.b)(d,"pixelBuffer"),y=this._schema&&Object(z.c)(d,["definitionExpression","gdbVersion","historicMoment"]);Object(h.a)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",d);var b={returnCentroid:"esriGeometryPolygon"===this._geometryType,returnGeometry:!0,outFields:t.outFields,outSpatialReference:this._outSR,orderByFields:["".concat(this._serviceInfo.objectIdField," ASC")],where:t.definitionExpression||"1=1",gdbVersion:t.gdbVersion,historicMoment:t.historicMoment?new Date(t.historicMoment):null,timeExtent:L.a.fromJSON(t.timeExtent)};e.source=!0,p&&(e.why.mesh.push("Pixel buffer changed"),e.mesh=!0),y&&(e.why.mesh.push("Layer filter changed"),e.why.source.push("Layer filter changed"),e.mesh=!0,e.queryFilter=!0,this._invalid.queryFilterParameters=!0),v&&(e.why.source.push("Layer required fields changed"),this._invalid.outFields=!0),this._schema=t,this._source.update(b),this._queryInfo=b}}},{key:"subscribe",value:function(e){this._subscriptions.display.has(e.id)||this._subscribeDisplayTile(e)}},{key:"unsubscribe",value:function(e){if(this._subscriptions.display.has(e.id)){var t=this._subscriptions.display.get(e.id);this._subscriptions.display.delete(e.id),this._source.unsubscribe(e),t.abort()}}},{key:"forEachRequest",value:function(e,t){this._source.forEachRequest(e,t)}},{key:"query",value:function(e){return this._source.query(e)}},{key:"createQuery",value:function(){return new P.a(Object(j.a)({},this._queryInfo))}},{key:"createTileQuery",value:function(e){if("stream"===this._serviceInfo.type)throw new Error("Service does not support tile  queries");var t=this.createQuery();return t.quantizationParameters=e.getQuantizationParameters(),t.resultType="tile",t.geometry=e.extent,"esriGeometryPolyline"===this._serviceInfo.geometryType&&(t.maxAllowableOffset=e.resolution),this._serviceInfo.capabilities.query.supportsQuantization||(t.quantizationParameters=null,t.maxAllowableOffset=e.resolution),t}},{key:"invalidate",value:function(){this._subscriptions.display.forEach((function(e){return e.invalid=!0}))}},{key:"forEachPendingEdit",value:function(e){this._getSubscriptions().some((function(e){return e.invalid}))?this._pendingEdits.forEach(e):this._pendingEdits.clear()}},{key:"onEdits",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,s,u,o,c=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.addedFeatures.filter((function(e){return!e.error})).map((function(e){return e.objectId})),n=t.updatedFeatures.filter((function(e){return!e.error})).map((function(e){return e.objectId})),s=t.deletedFeatures.filter((function(e){return!e.error})).map((function(e){return e.objectId})),u=[].concat(Object(D.a)(r),Object(D.a)(n)),s.forEach((function(e){c._pendingEdits.has(e)&&c._pendingEdits.delete(e)})),u.forEach((function(e){return c._pendingEdits.add(e)})),o=this._getSubscriptions().map((function(e){return e.displayTile})).map((function(e){var t=c.createTileQuery(e);return t.objectIds=u,{tile:e,query:t}})).map(function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.tile,n=t.query,e.t0=r,e.next=4,c._source.query(n);case 4:return e.t1=e.sent,e.abrupt("return",{tile:e.t0,result:e.t1});case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=5,Object(p.b)(o);case 5:e.sent.forEach((function(e){var t=e.tile,r=e.result,a=c._subscriptions.display.get(t.key.id);if(a){var i=a.signal,u=O.all();c.onDisplayTilePatch({type:"update",id:t.key.id,version:Je++,update:u,addOrUpdate:r,remove:[].concat(Object(D.a)(n),Object(D.a)(s)),end:!0,noData:!1},{signal:i})}})),this.invalidate();case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"resubscribe",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,u=this,o=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.length>1&&void 0!==o[1]&&o[1],n=this._schema.pixelBuffer,this._subscriptions.display.forEach((function(e){return e.setUpdate(t,n)})),i=!1,this._subscriptions.display.forEach((function(e){e.invalid&&(i=!0)})),this._invalid.outFields&&(this._invalid.outFields=!1),!(r||this._invalid.queryFilterParameters||i)){e.next=9;break}(s=this._getSubscriptions().map((function(e){return e.displayTile}))).forEach((function(e){return u.unsubscribe(e)})),s.forEach((function(e){return u.subscribe(e)})),this._source.resume(),this._invalid.queryFilterParameters=!1,e.next=16;break;case 9:if(!t.mesh){e.next=14;break}return e.next=12,this._source.resend({dataTileOnly:!1});case 12:e.next=16;break;case 14:return e.next=16,this._source.resend({dataTileOnly:!0});case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"pause",value:function(){this._source.pause()}},{key:"resume",value:function(){this._source.resume()}},{key:"_getSubscriptions",value:function(){var e=[];return this._subscriptions.display.forEach((function(t){e.push(t)})),e}},{key:"_subscribeDisplayTile",value:function(e){var t=new Ke(e,this._schema.pixelBuffer);this._subscriptions.display.set(e.id,t),this._source.subscribe(e);var r,n=Object(x.a)(t.partitions);try{for(n.s();!(r=n.n()).done;){var a=r.value,i=a.tile,s=this._source.get(i.id);if(Object(I.i)(s)){var u,o=Object(x.a)(s.requests.done);try{for(o.s();!(u=o.n()).done;){var c=u.value;this._onPartitionMessage(e.id,a,c.request,"new")}}catch(l){o.e(l)}finally{o.f()}}}}catch(l){n.e(l)}finally{n.f()}}},{key:"_onDataTileRequest",value:function(e,t,r){var n=this,a=this._subscriptions.display.get(e.id);if(r&&r.dataTileOnly){var i,s=Object(x.a)(a.partitions);try{for(s.s();!(i=s.n()).done;){var u=i.value;if(u.tile.id===e.id){this._onPartitionMessage(e.id,u,e,t);break}}}catch(h){s.e(h)}finally{s.f()}}else{var o,c=Object(x.a)(a.partitions);try{for(c.s();!(o=c.n()).done;){var l=o.value;if(l.tile.id===e.id){this._onPartitionMessage(e.id,l,e,t);break}}}catch(h){c.e(h)}finally{c.f()}this._subscriptions.display.forEach((function(r,a){if(a!==e.id){var i,s=Object(x.a)(r.partitions);try{for(s.s();!(i=s.n()).done;){var u=i.value;if(u.tile.id===e.id){n._onPartitionMessage(a,u,e,t);break}}}catch(h){s.e(h)}finally{s.f()}}}))}}},{key:"_onPartitionMessage",value:function(e,t,r,n){var a=Object(I.a)(r.features,(function(e){return function(e,t){if(Object(I.h)(t.extent))return e;var r=t.offset,n=t.extent,a=Object(q.a)(n,4),i=a[0],s=a[1],u=a[2],o=a[3],c=Object(q.a)(r,2),l=c[0],h=c[1];return e.extent(i,s,u,o).transform(l,h)}(e,t)})),i=this._subscriptions.display.get(e),s=i.signal,u=i.update;i.didSend||(n="replace"),Object(I.i)(a)&&!a.seen&&(u=O.all(),a.seen=!0);var o=!1;r.end&&(t.resolved=!0,o=e===t.tile.id),i.didSend=!0,this.onDisplayTilePatch({type:n,id:e,version:Je++,update:u,addOrUpdate:a,remove:r.remove||[],noData:r.noData,end:o},{signal:s})}}]),e}(),rt=r(59);new Float64Array(2),new Float64Array(2);function nt(e,t,r,n){n%2&&(n+=1);for(var a=0,i=0,s=-90,u=90,o=-180,c=180,l=0;l<n/2;l++){for(var h=0;h<5;h++){var f=(o+c)/2,d=r>f?1:0;a|=d<<29-(h+5*l),o=(1-d)*o+d*f,c=(1-d)*f+d*c}for(var v=0;v<5;v++){var p=(s+u)/2,y=t>p?1:0;i|=y<<29-(v+5*l),s=(1-y)*s+y*p,u=(1-y)*p+y*u}}e.geohashX=a,e.geohashY=i}function at(e,t,r,n,a){a%2&&(a+=1);for(var i=0,s=0,u=-90,o=90,c=-180,l=180,h=0;h<a/2;h++){for(var f=0;f<5;f++){var d=(c+l)/2,v=n>d?1:0;i|=v<<29-(f+5*h),c=(1-v)*c+v*d,l=(1-v)*d+v*l}for(var p=0;p<5;p++){var y=(u+o)/2,b=r>y?1:0;s|=b<<29-(p+5*h),u=(1-b)*u+b*y,o=(1-b)*y+b*o}}e[2*t]=i,e[2*t+1]=s}var it=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8096;Object(s.a)(this,e),this._nodes=0,this._root=new st(0,0,0),this._statisticFields=t,this._pool=r?new Te.a(8096):null}return Object(u.a)(e,[{key:"_acquire",value:function(e,t,r){this._nodes++;var n=null;return Object(I.i)(this._pool)&&(n=this._pool.dequeue()),Object(I.i)(n)?n.realloc(e,t,r):new st(e,t,r)}},{key:"_release",value:function(e){this._nodes--,Object(I.i)(this._pool)&&this._pool.enqueue(e)}},{key:"count",get:function(){return this._root.count}},{key:"size",get:function(){return this._nodes}},{key:"poolSize",get:function(){return Object(I.l)(this._pool,0,(function(e){return e.size}))}},{key:"depth",get:function(){var e=0;return this._forEachNode((function(t){return e=Math.max(e,t.depth)})),e}},{key:"dropLevels",value:function(e){var t=this;this._forEachNode((function(r){if(r.depth>=e)for(var n=0;n<r.children.length;n++){var a=r.children[n];r.children[n]=null,a&&t._release(a)}}))}},{key:"clear",value:function(){this.dropLevels(0)}},{key:"insert",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=T.a.fromOptimizedFeatures([e],"esriGeometryPoint").getCursor();n.next();var a=n.readGeometry();if(a){var i=Object(q.a)(a.coords,2),s=i[0],u=i[1],o=e.geohashX,c=e.geohashY;this.insertCursor(n,e.displayId,s,u,o,c,t,r)}}},{key:"insertCursor",value:function(e,t,r,n,a,i,s){for(var u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,o=this._root,c=0,l=0,h=0;null!==o;){if(o.depth>=u&&(o.count+=1,o.xTotal+=r,o.yTotal+=n,o.xGeohashTotal+=a,o.yGeohashTotal+=i,o.displayId=t,this._updateStatisticsCursor(e,o,1)),c>=s)return void o.add(t);var f=Math.ceil((c+1)/2),d=Math.floor((c+1)/2),v=1-c%2,p=30-(3*f+2*d),y=30-(2*f+3*d),b=(a&7*v+3*(1-v)<<p)>>p,g=(i&3*v+7*(1-v)<<y)>>y,_=b+g*(8*v+4*(1-v));l=l<<3*v+2*(1-v)|b,h=h<<2*v+3*(1-v)|g,null==o.children[_]&&(o.children[_]=this._acquire(l,h,c+1)),c+=1,o=o.children[_]}}},{key:"remove",value:function(e,t){var r=T.a.fromOptimizedFeatures([e],"esriGeometryPoint").getCursor();r.next();var n=r.readGeometry();if(n){var a=Object(q.a)(n.coords,2),i=a[0],s=a[1],u=e.geohashX,o=e.geohashY;this.removeCursor(r,i,s,u,o,t)}}},{key:"removeCursor",value:function(e,t,r,n,a,i){for(var s=this._root,u=0;null!==s;){if(s.count-=1,s.xTotal-=t,s.yTotal-=r,s.xGeohashTotal-=n,s.yGeohashTotal-=a,this._updateStatisticsCursor(e,s,-1),u>=i)return void s.remove(e.getDisplayId());var o=Math.ceil((u+1)/2),c=Math.floor((u+1)/2),l=1-u%2,h=30-(3*o+2*c),f=30-(2*o+3*c),d=((n&7*l+3*(1-l)<<h)>>h)+((a&3*l+7*(1-l)<<f)>>f)*(8*l+4*(1-l)),v=s.children[d];1===v.count&&(this._release(v),s.children[d]=null),u+=1,s=v}}},{key:"find",value:function(e,t,r){return this._root.find(e,t,r,0,0,0)}},{key:"findSingleOccupancyNode",value:function(e,t,r,n,a){for(var i=this._root;null!==i;){var s=i.depth,u=i.xNode,o=i.yNode,c=1-s%2,l=i.xGeohashTotal/i.count,h=i.yGeohashTotal/i.count;if(1===i.count&&e<l&&l<=r&&t<h&&h<=n)return i;if(s>=a)i=i.next;else{for(var f=Math.ceil((s+1)/2),d=Math.floor((s+1)/2),v=30-(3*f+2*d),p=30-(2*f+3*d),y=~((1<<v)-1),b=~((1<<p)-1),g=(e&y)>>v,_=(t&b)>>p,m=(r&y)>>v,k=(n&b)>>p,x=u<<3*c+2*(1-c),O=o<<2*c+3*(1-c),j=x+8*c+4*(1-c),I=O+4*c+8*(1-c),w=Math.max(x,g),S=Math.max(O,_),F=Math.min(j,m),T=Math.min(I,k),C=null,E=null,A=S;A<=T;A++)for(var R=w;R<=F;R++){var M=R-x+(A-O)*(8*c+4*(1-c)),q=i.children[M];q&&(C||((C=q).next=i.next),E&&(E.next=q),E=q,q.next=i.next)}i=C||i.next}}return null}},{key:"getRegionDisplayIds",value:function(e,t,r,n,a){for(var i=this._root,s=[];null!==i;){var u=i.depth,o=i.xNode,c=i.yNode;if(u>=a){var l=i.xGeohashTotal/i.count,h=i.yGeohashTotal/i.count;e<=l&&l<=r&&t<=h&&h<=n&&i.displayIds.forEach((function(e){return s.push(e)})),i=i.next}else{for(var f=Math.ceil((u+1)/2),d=Math.floor((u+1)/2),v=1-u%2,p=30-(3*f+2*d),y=30-(2*f+3*d),b=~((1<<p)-1),g=~((1<<y)-1),_=(e&b)>>p,m=(t&g)>>y,k=(r&b)>>p,x=(n&g)>>y,O=o<<3*v+2*(1-v),j=c<<2*v+3*(1-v),I=O+8*v+4*(1-v),w=j+4*v+8*(1-v),S=Math.max(O,_),F=Math.max(j,m),T=Math.min(I,k),C=Math.min(w,x),E=null,A=null,R=F;R<=C;R++)for(var M=S;M<=T;M++){var q=M-O+(R-j)*(8*v+4*(1-v)),D=i.children[q];D&&(E||((E=D).next=i.next),A&&(A.next=D),A=D,D.next=i.next)}i=E||i.next}}return s}},{key:"getRegionStatistics",value:function(e,t,r,n,a){for(var i=this._root,s=0,u=0,o=0,c={},l=0;null!==i;){var h=i.depth,f=i.xNode,d=i.yNode;if(h>=a){var v=i.xGeohashTotal/i.count,p=i.yGeohashTotal/i.count;e<v&&v<=r&&t<p&&p<=n&&(s+=i.count,u+=i.xTotal,o+=i.yTotal,1===i.count&&(l=i.displayId),this._aggregateStatistics(c,i.statistics)),i=i.next}else{for(var y=Math.ceil((h+1)/2),b=Math.floor((h+1)/2),g=1-h%2,_=30-(3*y+2*b),m=30-(2*y+3*b),k=~((1<<_)-1),x=~((1<<m)-1),O=(e&k)>>_,j=(t&x)>>m,I=(r&k)>>_,w=(n&x)>>m,S=f<<3*g+2*(1-g),F=d<<2*g+3*(1-g),T=S+8*g+4*(1-g),C=F+4*g+8*(1-g),E=Math.max(S,O),A=Math.max(F,j),R=Math.min(T,I),M=Math.min(C,w),q=null,D=null,L=A;L<=M;L++)for(var z=E;z<=R;z++){var P=z-S+(L-F)*(8*g+4*(1-g)),N=i.children[P];if(N){if(L!==A&&L!==M&&z!==E&&z!==R){var U=N.xGeohashTotal/N.count,G=N.yGeohashTotal/N.count;e<U&&U<=r&&t<G&&G<=n&&(s+=N.count,u+=N.xTotal,o+=N.yTotal,1===N.count&&(l=N.displayId),this._aggregateStatistics(c,N.statistics));continue}q||((q=N).next=i.next),D&&(D.next=N),D=N,N.next=i.next}}i=q||i.next}}return{count:s,attributes:this._normalizeStatistics(c,s),xTotal:u,yTotal:o,referenceId:l}}},{key:"_forEachNode",value:function(e){for(var t=this._root;null!==t;){var r=this._linkChildren(t)||t.next;e(t),t=r}}},{key:"_linkChildren",value:function(e){for(var t=null,r=null,n=0;n<=e.children.length;n++){var a=e.children[n];a&&(t||((t=a).next=e.next),r&&(r.next=a),r=a,a.next=e.next)}return t}},{key:"_updateStatisticsCursor",value:function(e,t,r){var n,a=Object(x.a)(this._statisticFields);try{for(a.s();!(n=a.n()).done;){var i=n.value,s=i.name,u=i.inField?e.readAttribute(i.inField):e.getComputedNumericAtIndex(i.inFieldIndex);switch(i.statisticType){case"norm":t.statistics[s]||(t.statistics[s]={});var o=i.inNormalizationField,c=e.readAttribute(o),l=t.statistics[s].onStatisticField||0,h=t.statistics[s].onStatisticNormalizationField||0;null==u||isNaN(u)||null==c||0===c||isNaN(c)||(t.statistics[s].onStatisticField=l+r*u,t.statistics[s].onStatisticNormalizationField=h+r*c);break;case"sum":case"avg":t.statistics[s]||(t.statistics[s]={value:0,nanCount:0});var f=t.statistics[s].value,d=t.statistics[s].nanCount;null==u||isNaN(u)?t.statistics[s].nanCount=d+r:t.statistics[s].value=f+r*u;break;case"avg_angle":t.statistics[s]||(t.statistics[s]={x:0,y:0,nanCount:0});var v=t.statistics[s].x,p=t.statistics[s].y,y=t.statistics[s].nanCount,b=Math.PI/180;null==u||isNaN(u)?t.statistics[s].nanCount=y+r:(t.statistics[s].x=v+r*Math.cos(u*b),t.statistics[s].y=p+r*Math.sin(u*b));break;case"mode":t.statistics[s]||(t.statistics[s]={});var g=t.statistics[s][u]||0;t.statistics[s][u]=g+r}}}catch(_){a.e(_)}finally{a.f()}}},{key:"_aggregateStatistics",value:function(e,t){var r,n=Object(x.a)(this._statisticFields);try{for(n.s();!(r=n.n()).done;){var a=r.value,i=a.name;switch(a.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":for(var s in e[i]||(e[i]={}),t[i]){var u=e[i][s]||0;e[i][s]=u+t[i][s]}}}}catch(o){n.e(o)}finally{n.f()}}},{key:"_normalizeStatistics",value:function(e,t){var r,n={},a=Object(x.a)(this._statisticFields);try{for(a.s();!(r=a.n()).done;){var i=r.value,s=i.name;switch(i.statisticType){case"norm":var u=e[s];if(t&&null==u.onStatisticNormalizationField)break;if(t&&u.onStatisticNormalizationField){n[s]=u.onStatisticField/u.onStatisticNormalizationField;break}n[s]=0;break;case"sum":if(!t)break;var o=e[s],c=o.value;if(!(t-o.nanCount))break;n[s]=c;break;case"avg":if(!t)break;var l=e[s],h=l.value,f=l.nanCount;if(!(t-f))break;n[s]=h/(t-f);break;case"avg_angle":if(!t)break;var d=e[s],v=d.x,p=d.y,y=d.nanCount;if(!(t-y))break;var b=v/(t-y),g=p/(t-y),_=180/Math.PI,m=Math.atan2(g,b)*_;n[s]=m;break;case"mode":var k=e[s],O=0,j=null;for(var I in k){var w=k[I];w>O&&(O=w,j=I)}n[s]="null"===j?null:j}}}catch(S){a.e(S)}finally{a.f()}return n}}]),e}(),st=function(){function e(t,r,n){Object(s.a)(this,e),this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(var a=0;a<this.children.length;a++)this.children[a]=null;this.xNode=t,this.yNode=r,this.depth=n}return Object(u.a)(e,[{key:"realloc",value:function(e,t,r){for(var n=0;n<this.children.length;n++)this.children[n]=null;return this.xNode=e,this.yNode=t,this.depth=r,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}},{key:"add",value:function(e){this.displayIds.add(e)}},{key:"remove",value:function(e){this.displayIds.delete(e)}},{key:"getLngLatBounds",value:function(){var e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2),n=30-(3*t+2*r),a=30-(2*t+3*r);return function(e,t){for(var r=-90,n=90,a=-180,i=180,s=0;s<t;s++){for(var u=Math.ceil((s+1)/2),o=Math.floor((s+1)/2),c=1-s%2,l=30-(3*u+2*o),h=30-(2*u+3*o),f=3*c+2*(1-c),d=2*c+3*(1-c),v=3*c+7*(1-c)<<h,p=(7*c+3*(1-c)<<l&e.geohashX)>>l,y=(v&e.geohashY)>>h,b=f-1;b>=0;b--){var g=(a+i)/2,_=p&1<<b?1:0;a=(1-_)*a+_*g,i=(1-_)*g+_*i}for(var m=d-1;m>=0;m--){var k=(r+n)/2,x=y&1<<m?1:0;r=(1-x)*r+x*k,n=(1-x)*k+x*n}}return[a,r,i,n]}({geohashX:this.xNode<<n,geohashY:this.yNode<<a},this.depth)}},{key:"find",value:function(e,t,r,n,a,i){if(n>=r)return this;var s=1-n%2,u=3*s+2*(1-s),o=2*s+3*(1-s),c=30-a-u,l=30-i-o,h=((e&7*s+3*(1-s)<<c)>>c)+((t&3*s+7*(1-s)<<l)>>l)*(8*s+4*(1-s)),f=this.children[h];return null==f?null:f.find(e,t,r,n+1,a+u,i+o)}}]),e}(),ut=r(1059),ot=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e,n,a,i,u){var o;return Object(s.a)(this,r),(o=t.call(this,new te.a([],[n,a]),i,null,e)).geohashBoundsInfo=u,o}return Object(u.a)(r,[{key:"count",get:function(){return this.attributes.cluster_count}},{key:"update",value:function(e,t,r,n,a,i){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=r,this.attributes=n,this.geohashBoundsInfo=a,this.referenceId=null,this.referenceId=i,this}},{key:"toJSON",value:function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:Object(j.a)(Object(j.a)({},this.attributes),{},{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}],[{key:"create",value:function(e,t,n,a,i,s,u,o){var c=new r(t,n,a,s,u);return c.displayId=e.createDisplayId(!0),c.referenceId=o,c.tileLevel=i,c}}]),r}(ee.a);function ct(e){return 57.29577951308232*e}var lt=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e,n,a){var i;return Object(s.a)(this,r),(i=t.call(this,e,a)).events=new be.a,i._geohashLevel=0,i._aggregateValueRanges={},i._aggregateValueRangesChanged=!1,i._geohashBuf=[],i._clusters=new Map,i._tiles=new Map,i.geometryInfo=e.geometryInfo,i._spatialReference=n,i._projectionSupportCheck=Object(W.a)(n,De.a.WGS84),i._bitsets.geohash=a.getBitset(a.createBitset()),i._bitsets.inserted=a.getBitset(a.createBitset()),i}return Object(u.a)(r,[{key:"updateSchema",value:function(){var e=Object(i.a)(a.a.mark((function e(t,n){var i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._schema,e.prev=1,e.next=4,Object(G.a)(Object(B.a)(r.prototype),"updateSchema",this).call(this,t,n);case 4:return e.next=6,this._projectionSupportCheck;case 6:e.next=10;break;case 8:e.prev=8,e.t0=e.catch(1);case 10:s=Object(z.a)(i,n),t.mesh&&(t.targets.aggregate=!0),n&&(!Object(I.h)(s)||t.source||t.storage.filters)&&((Object(z.b)(s,"params.fields")||!this._tree||t.source)&&(this._tree=new it(this._statisticFields),this._rebuildTree(),Object(h.a)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),Object(h.a)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",s),t.mesh=!0,t.targets[n.name]=!0,this._aggregateValueRanges={});case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"sweepFeatures",value:function(e,t){var r=this;this._bitsets.inserted.forEachSet((function(n){if(!e.has(n)){var a=t.lookupByDisplayIdUnsafe(n);r._remove(a)}}))}},{key:"sweepClusters",value:function(e,t,r){var n=this;this._clusters.forEach((function(a,i){a&&a.tileLevel!==r&&(e.releaseDisplayId(a.displayId),t.unsetAttributeData(a.displayId),n._clusters.delete(i))}))}},{key:"onTileData",value:function(e,t,r,n,a){if(!this._schema||Object(I.h)(t.addOrUpdate))return t;for(var i=this._tree,s=this._getTransforms(e,this._spatialReference),u=t.addOrUpdate.getCursor();u.next();)this._update(u,n,i);if(!a)return t;var o=new Array,c=this._schema.params.clusterRadius;this._getClustersForTile(o,e,c,r,i,s),t.type="replace"===t.type?"replace":"update",t.addOrUpdate=T.a.fromOptimizedFeatures(o,"esriGeometryPoint"),t.addOrUpdate._storage=r;for(var l=t.addOrUpdate.getCursor();l.next();){var h=l.getDisplayId();this._bitsets.computed.unset(h),this.setComputedAttributes(r,l,h,e.scale)}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t}},{key:"onTileUpdate",value:function(e){var t=this,r=e.added,n=e.removed;if(r.length){var a=r[0].level;this._setGeohashLevel(a)}if(this._schema){var i=this._schema.params.clusterRadius;n.forEach((function(e){t._tiles.delete(e.key.id),t._markTileClustersForDeletion(e,i)}))}}},{key:"getAggregate",value:function(e){var t=null;return this._clusters.forEach((function(r){r&&r.displayId===e&&(t=r.toJSON())})),t}},{key:"getDisplayId",value:function(e){var t=this._clusters.get(e);return t?t.displayId:null}},{key:"getFeatureDisplayIdsForAggregate",value:function(e){var t=this._clusters.get(e);if(!t)return[];var r=t.geohashBoundsInfo;return this._tree.getRegionDisplayIds(r.xLL,r.yLL,r.xTR,r.yTR,r.level)}},{key:"getDisplayIdForReferenceId",value:function(e){var t;return this._clusters.forEach((function(r){r&&r.referenceId===e&&(t=r.displayId)})),t}},{key:"getAggregateValueRanges",value:function(){return this._aggregateValueRanges}},{key:"forEach",value:function(e){this._clusters.forEach((function(t,r){t&&e(t,r)}))}},{key:"size",value:function(){var e=0;return this.forEach((function(t){return e++})),e}},{key:"_rebuildTree",value:function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._bitsets.geohash.clear(),this._tree&&this._tree.clear()}},{key:"_remove",value:function(e){var t=e.getDisplayId(),r=e.getXHydrate(),n=e.getYHydrate(),a=this._geohashBuf[2*t],i=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,r,n,a,i,this._geohashLevel))}},{key:"_update",value:function(e,t,r){var n=e.getDisplayId(),a=this._bitsets.inserted,i=t.isVisible(n);if(i!==a.has(n))if(i){var s=e.getXHydrate(),u=e.getYHydrate();if(this._setGeohash(n,s,u)){var o=this._geohashBuf[2*n],c=this._geohashBuf[2*n+1];r.insertCursor(e,n,s,u,o,c,this._geohashLevel),a.set(n)}}else this._remove(e)}},{key:"_setGeohash",value:function(e,t,r){if(this._bitsets.geohash.has(e))return!0;var n=this._geohashBuf;if(this._spatialReference.isWebMercator){var a=ct(t/rt.a.radius),i=a-360*Math.floor((a+180)/360);at(n,e,ct(Math.PI/2-2*Math.atan(Math.exp(-1*r/rt.a.radius))),i,12)}else{var s=Object(W.b)({x:t,y:r},this._spatialReference,De.a.WGS84);if(!s)return!1;at(n,e,s.y,s.x,12)}return this._bitsets.geohash.set(e),!0}},{key:"_getClustersForTile",value:function(e,t,r,n,a,i){for(var s=this,u=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],o=this._schema.params.clusterPixelBuffer,c=2*r,l=this._getGeohashLevel(t.key.level),h=Math.ceil(Math.pow(2,t.key.level)*N.F/c),f=Math.ceil(o/c)+0,d=Math.ceil(N.F/c),v=t.key,p=v.row,y=v.col,b=y*N.F,g=p*N.F,_=Math.floor(b/c)-f,m=Math.floor(g/c)-f,k=_+d+2*f,x=m+d+2*f,O=t.tileInfoView.getLODInfoAt(t.key.level),w=_;w<=k;w++)for(var F=function(r){var o=w;O.wrap&&(o=w<0?w+h:w%h);var c=O.wrap&&w<0,f=O.wrap&&w%h!==w,d=s._lookupCluster(n,O,t.key.level,o,r,l,a);if(Object(I.i)(d)){var v=Object(I.a)(i,(function(e){return c?e.left:f?e.right:e.tile}));if(u&&Object(I.h)(v))return"continue";if(!d.count)return"continue";if(Object(I.i)(v)&&u){var p=d.geometry.clone(),y=d.attributes;p.coords[0]=Object(S.v)(v,p.coords[0]),p.coords[1]=Object(S.w)(v,p.coords[1]),1===d.count&&Object(I.i)(d.referenceId)&&(y=Object(j.a)(Object(j.a)({},d.attributes),{},{referenceId:d.referenceId}));var b=new ee.a(p,y);b.displayId=d.displayId,e.push(b)}}},T=m;T<=x;T++)F(T)}},{key:"_getGeohashLevel",value:function(e){return Math.min(Math.ceil(e/2+2),12)}},{key:"_setGeohashLevel",value:function(e){var t=this._getGeohashLevel(e),r=1*(Math.floor(t/1)+1)-1;if(this._geohashLevel!==r)return this._geohashLevel=r,void this._rebuildTree()}},{key:"_getTransforms",value:function(e,t){var r={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},n=Object(H.d)(t);if(!n)return{tile:r,left:null,right:null};var a=Object(q.a)(n.valid,2),i=a[0],s=a[1];return{tile:r,left:Object(j.a)(Object(j.a)({},r),{},{translate:[s,e.bounds[3]]}),right:Object(j.a)(Object(j.a)({},r),{},{translate:[i-s+e.bounds[0],e.bounds[3]]})}}},{key:"_getClusterId",value:function(e,t,r){return(15&e)<<28|(16383&t)<<14|16383&r}},{key:"_markForDeletion",value:function(e,t,r){var n=this._getClusterId(e,t,r);this._clusters.delete(n)}},{key:"_getClusterBounds",value:function(e,t,r){var n=this._schema.params.clusterRadius,a=2*n,i=r%2?t*a:t*a-n,s=r*a,u=i+a,o=s-a,c=Math.pow(2,e.level)*N.F;e.wrap&&i<0&&(i=0),e.wrap&&u>c&&(u=c);var l=i/N.F,h=s/N.F,f=u/N.F,d=o/N.F;return[e.getXForColumn(l),e.getYForRow(h),e.getXForColumn(f),e.getYForRow(d)]}},{key:"_lookupCluster",value:function(e,t,r,n,a,i,s){var u=this._getClusterId(r,n,a),o=this._clusters.get(u),c=this._getClusterBounds(t,n,a),l=Object(q.a)(c,4),h=l[0],f=l[1],d=l[2],v=l[3],p={x:h,y:f},y={x:d,y:v},b=0,g=0,_=0,m=0;if(this._spatialReference.isWebMercator){var k=ct(p.x/rt.a.radius);b=k-360*Math.floor((k+180)/360),g=ct(Math.PI/2-2*Math.atan(Math.exp(-1*p.y/rt.a.radius)));var x=ct(y.x/rt.a.radius);_=x-360*Math.floor((x+180)/360),m=ct(Math.PI/2-2*Math.atan(Math.exp(-1*y.y/rt.a.radius)))}else{var O=Object(W.b)(p,this._spatialReference,De.a.WGS84),w=Object(W.b)(y,this._spatialReference,De.a.WGS84);if(!O||!w)return null;b=O.x,g=O.y,_=w.x,m=w.y}var S={geohashX:0,geohashY:0},F={geohashX:0,geohashY:0};nt(S,g,b,i),nt(F,m,_,i);var T=S.geohashX,C=S.geohashY,E=F.geohashX,A=F.geohashY,R={xLL:T,yLL:C,xTR:E,yTR:A,level:i},M=s.getRegionStatistics(T,C,E,A,i),D=M.count,L=M.xTotal,z=M.yTotal,P=M.referenceId,N=D?L/D:0,U=D?z/D:0;if(0===D)return this._clusters.set(u,null),null;var G=Object(j.a)({cluster_count:D},M.attributes),B=Object(I.i)(o)?o.update(N,U,r,G,R,P):ot.create(e,u,N,U,r,G,R,P);return 0===D&&(B.geometry.coords[0]=(h+d)/2,B.geometry.coords[1]=(f+v)/2),this._clusters.set(u,B),this._updateAggregateValueRangeForCluster(B,B.tileLevel),B}},{key:"_updateAggregateValueRangeForCluster",value:function(e,t){var r=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},n=r.minValue,a=r.maxValue;r.minValue=Math.min(n,e.count),r.maxValue=Math.max(a,e.count),this._aggregateValueRanges[t]=r,n===r.minValue&&a===r.maxValue||(this._aggregateValueRangesChanged=!0)}},{key:"_markTileClustersForDeletion",value:function(e,t){for(var r=2*t,n=Math.ceil(N.F/r),a=e.key,i=a.row,s=a.col*N.F,u=i*N.F,o=Math.floor(s/r),c=Math.floor(u/r),l=o;l<o+n;l++)for(var h=c;h<c+n;h++)this._markForDeletion(e.key.level,l,h)}}]),r}(ut.a);function ht(e){if(!Object(p.n)(e)&&!function(e){return"worker:port-closed"===e.name}(e))throw e}var ft=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(){var e;return Object(s.a)(this,r),(e=t.apply(this,arguments))._storage=new A.a,e._markedIdsBufId=e._storage.createBitset(),e._lastCleanup=performance.now(),e._cleanupNeeded=!1,e._invalidated=!1,e._tileToResolver=new Map,e.tileStore=null,e.config=null,e.processor=null,e.remoteClient=null,e.service=null,e._editing=!1,e}return Object(u.a)(r,[{key:"initialize",value:function(){var e=this;this._initAttributeStore(),this._initStores(),this._initQueryEngine(),this._initSource(),this._updateQueue=new C.a({concurrency:4,process:function(t,r){return e._onDisplayTilePatch(t,{signal:r})}}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),this.watch("updating",(function(t){return!t&&e.onIdle()}))])}},{key:"startup",value:function(){var e=Object(i.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._initAttributeStore();case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_initSource",value:function(){var e=this;this._source=new tt(this.service,this.spatialReference,this.tileStore.tileScheme),this._source.onDisplayTilePatch=function(t,r){return e._invalidated=!0,e._patchTile(t,r)},this._source.canAcceptPatch=function(){return e._updateQueue.length<50};var t=this._source.sourceEvents;if("geoevent"===t.type){var r=t.events;this.handles.add([r.on("connectionStatus",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:t}).catch(ht)})),r.on("errorString",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"errorString",value:t}).catch(ht)})),r.on("feature",(function(t){return e.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry}}).catch(ht)})),r.on("updateRate",(function(t){return e.remoteClient.invoke("emitEvent",{name:"update-rate",event:Object(j.a)({},t)}).catch(ht)}))])}}},{key:"_initAttributeStore",value:function(){var e=this;this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new E.a({type:"remote",initialize:function(t,r){return Object(p.m)(e.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",t,{signal:r}).catch(ht))},update:function(t,r){return Object(p.m)(e.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",t,{signal:r}).catch(ht))},render:function(t){return Object(p.m)(e.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:t}).catch(ht))}},this.config)}},{key:"_initStores",value:function(){var e=this,t={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new R.a(t,this._storage),this.aggregateStore=new lt(t,this.spatialReference,this._storage),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",(function(t){e.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:t.valueRanges}}).catch(ht)})))}},{key:"_initQueryEngine",value:function(){var e,t=this;null==(e=this.queryEngine)||e.destroy(),this.queryEngine=new M.a({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:function(e){return t.aggregateStore.getFeatureDisplayIdsForAggregate(e).map((function(e){return t.getObjectId(e)}))}},timeInfo:this.service.timeInfo})}},{key:"destroy",value:function(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy()}},{key:"fieldsIndex",get:function(){return new F.a(this.service.fields)}},{key:"hasAggregates",get:function(){return!!this.config.schema.targets.aggregate}},{key:"spatialReference",get:function(){return this.tileStore.tileScheme.spatialReference}},{key:"updating",get:function(){return this.isUpdating()}},{key:"isUpdating",value:function(){return this._source.updating||!!this._updateQueue.length}},{key:"enableEvent",value:function(e){this._source.enableEvent(e.name,e.value)}},{key:"invalidate",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s,u,o=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.any()){e.next=2;break}return e.abrupt("return");case 2:if(Object(h.a)("esri-2d-update-debug")&&t.describe(),r=this.tileStore.tiles.map((function(e){var t=e.key,r=Object(p.g)();return o._tileToResolver.set(t.id,r),r.promise})),n=this._updateQueue.takeAll(),this._updateQueue.resume(),!(this.hasAggregates&&t.mesh&&t.targets.aggregate)||t.queryFilter){e.next=9;break}this._repushAggregateMeshTiles(t),e.next=15;break;case 9:if(this._source.resubscribe(t),Object(p.b)(r).then((function(){o._source.resume()})),e.t0=t.mesh,!e.t0){e.next=15;break}return e.next=15,Object(w.g)(this,"updating");case 15:return this.notifyChange("updating"),e.next=18,Object(p.b)(r);case 18:this._updateQueue.pause(),i=Object(x.a)(n);try{for(i.s();!(s=i.n()).done;)u=s.value,this._patchTile(u)}catch(a){i.e(a)}finally{i.f()}t.source&&(this._cleanupNeeded=!0);case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"resume",value:function(){return this._updateQueue.resume(),this._source.resume()}},{key:"update",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.length>2&&void 0!==i[2]&&i[2],e.t0=this._editing,!e.t0){e.next=5;break}return e.next=5,Object(w.g)(this,"updating");case 5:return n&&(this._source.pause(),this._updateQueue.pause()),this._set("config",r),this._schema=r.schema,this._initQueryEngine(),e.next=11,Object(p.b)([this._source.update(t,r.schema.source),this.featureStore.updateSchema(t,r.schema.targets.feature),this.attributeStore.update(t,r),this.attributeStore.updateFilters(t,this)]);case 11:return e.next=13,this.aggregateStore.updateSchema(t,r.schema.targets.aggregate);case 13:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"refresh",value:function(){var e=Object(i.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._source.resubscribe(O.all(),!0),this._cleanupNeeded=!0,this.notifyChange("updating"),e.next=5,Object(w.g)(this,"updating",!0);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"onTileUpdate",value:function(e){this.aggregateStore.onTileUpdate(e);var t,r=Object(x.a)(e.added);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._source.subscribe(n),this._level=n.level}}catch(u){r.e(u)}finally{r.f()}var a,i=Object(x.a)(e.removed);try{for(i.s();!(a=i.n()).done;){var s=a.value;this._source.unsubscribe(s),this._cleanupNeeded=!0,this._tileToResolver.has(s.id)&&(this._tileToResolver.get(s.id).resolve(),this._tileToResolver.delete(s.id))}}catch(u){i.e(u)}finally{i.f()}this.notifyChange("updating")}},{key:"onIdle",value:function(){this.hasAggregates&&this._invalidated&&(this._repushAggregateMeshTiles(),this._invalidated=!1),this._markAndSweep()}},{key:"onEdits",value:function(){var e=Object(i.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._editing){e.next=6;break}return e.next=3,Object(w.g)(this,"updating");case 3:return e.next=5,Object(p.a)(16);case 5:return e.abrupt("return",this.onEdits(t));case 6:return this._editing=!0,e.prev=7,e.next=10,this._source.onEdits(t);case 10:return e.next=12,Object(w.g)(this,"updating");case 12:e.next=16;break;case 14:e.prev=14,e.t0=e.catch(7);case 16:this._editing=!1;case 17:case"end":return e.stop()}}),e,this,[[7,14]])})));return function(t){return e.apply(this,arguments)}}()},{key:"queryExtent",value:function(e){return this.queryEngine.executeQueryForExtent(e)}},{key:"queryFeatures",value:function(e){return this.queryEngine.executeQuery(e)}},{key:"queryFeatureCount",value:function(e){return this.queryEngine.executeQueryForCount(e)}},{key:"queryLatestObservations",value:function(e){return this.queryEngine.executeQueryForLatestObservations(e)}},{key:"queryObjectIds",value:function(e){return this.queryEngine.executeQueryForIds(e)}},{key:"queryStatistics",value:function(){var e=Object(i.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(j.a)(Object(j.a)({},this.featureStore.storeStatistics),{},{displayedFeatureCount:0,displayedVertexCount:0,displayPreProcessTime:0}));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getObjectId",value:function(e){return this.featureStore.lookupObjectId(e,this._storage)}},{key:"getDisplayId",value:function(e){if(this._schema.targets.aggregate){var t=this.aggregateStore.getDisplayId(e);if(Object(I.h)(t)){var r=this.featureStore.lookupDisplayId(e);return this.aggregateStore.getDisplayIdForReferenceId(r)}return t}return this.featureStore.lookupDisplayId(e)}},{key:"getFeature",value:function(e){var t=this.featureStore.lookupFeatureByDisplayId(e,this._storage);if(Object(I.h)(t))return null;var r=t.readHydratedGeometry(),n=Object(S.k)(r,t.geometryType,t.hasZ,t.hasM);return{attributes:t.readAttributes(),geometry:n}}},{key:"getAggregate",value:function(e){return this.aggregateStore.getAggregate(e)}},{key:"setHighlight",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.map((function(e){return n.getDisplayId(e)})),e.abrupt("return",this.attributeStore.setHighlight(t,r));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_repushAggregateMeshTiles",value:function(e){var t,r=Object(x.a)(this.tileStore.tiles);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._patchTile({type:"replace",id:n.key.id,addOrUpdate:T.a.fromOptimizedFeatures([],this.service.geometryType),remove:[],end:!0,noData:!1,update:e||O.create({mesh:!0,targets:{aggregate:!0}})})}}catch(a){r.e(a)}finally{r.f()}}},{key:"_maybeForceCleanup",value:function(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}},{key:"_patchTile",value:function(e,t){var r=this,n=this._updateQueue.push(e,t).then((function(){r.notifyChange("updating")})).catch((function(e){r.notifyChange("updating")}));return this.notifyChange("updating"),n}},{key:"_onDisplayTilePatch",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s,u,o,c,l,h;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(p.w)(r),n=this.tileStore.get(t.id)){e.next=4;break}return e.abrupt("return");case 4:i=t.update,t.remove.length&&(this._cleanupNeeded=!0),s=[],u=Object(x.a)(t.remove);try{for(u.s();!(o=u.n()).done;)c=o.value,s.push(this.featureStore.lookupDisplayId(c))}catch(a){u.e(a)}finally{u.f()}if(t.remove=s,e.prev=10,!Object(I.h)(t.addOrUpdate)){e.next=13;break}return e.abrupt("return",(this.processor.onTileData(n,Object(j.a)(Object(j.a)({},t),{},{addOrUpdate:null}),r).catch((function(e){Object(p.x)(e)})),void this._finishedPatch(t)));case 13:if(t.addOrUpdate._storage=this._storage,l=t.addOrUpdate.hasFilter(),h=t.addOrUpdate.instance,t.addOrUpdate._arcadeSpatialReference=this.spatialReference,(!this.featureStore.hasInstance(h)||i.targets.feature&&!l)&&this.featureStore.onTileData(n,t,this._storage),e.t0=!i.storage.data&&!i.storage.filters||l,e.t0){e.next=26;break}if(this.attributeStore.onTileData(n,t),!this._source.isStream){e.next=25;break}return e.next=23,this.attributeStore.sendUpdates();case 23:e.next=26;break;case 25:this.attributeStore.sendUpdates();case 26:if(e.t1=this.hasAggregates&&i.targets.aggregate,!e.t1){e.next=34;break}if(this.aggregateStore.onTileData(n,t,this._storage,this.attributeStore,i.mesh),e.t2=i.mesh,!e.t2){e.next=34;break}return this.attributeStore.onTileData(n,t),e.next=34,this.attributeStore.sendUpdates();case 34:if(e.t3=i.mesh,!e.t3){e.next=38;break}return e.next=38,this.processor.onTileData(n,t,r);case 38:this._maybeForceCleanup(),this._finishedPatch(t),e.next=45;break;case 42:e.prev=42,e.t4=e.catch(10),Object(p.x)(e.t4);case 45:case"end":return e.stop()}}),e,this,[[10,42]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_finishedPatch",value:function(e){(e.noData||e.end)&&this._tileToResolver.has(e.id)&&(this._tileToResolver.get(e.id).resolve(),this._tileToResolver.delete(e.id))}},{key:"_markAndSweep",value:function(){var e=this;if(this._lastCleanup=performance.now(),this._cleanupNeeded||this._source.isStream){this._cleanupNeeded=!1;var t=this._storage.getBitset(this._markedIdsBufId),r=new Set;t.clear();var n,a=function(n){var a=e.featureStore.lookupDisplayId(n),i=(4294901760&e._storage.getInstanceId(a))>>>16;a&&(r.add(i),t.set(a))},i=Object(x.a)(this.tileStore.tiles);try{for(i.s();!(n=i.n()).done;){var s=n.value;this._source.forEachRequest(s.key.id,(function(e){if(!Object(I.h)(e.features))for(var t=e.features.getCursor();t.next();){var r=t.getObjectId();a(r)}}))}}catch(u){i.e(u)}finally{i.f()}this._source.forEachPendingEdit((function(e){return a(e)})),this._updateQueue.forEach((function(e){var t,r=Object(x.a)(e.remove);try{for(r.s();!(t=r.n()).done;){var n=t.value;a(n)}}catch(u){r.e(u)}finally{r.f()}})),this.config.schema.targets.aggregate&&(this.aggregateStore.sweepFeatures(t,this.featureStore),this.aggregateStore.sweepClusters(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(t,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(r)}}}]),r}(y.a);Object(l.a)([Object(d.b)({constructOnly:!0})],ft.prototype,"tileStore",void 0),Object(l.a)([Object(d.b)()],ft.prototype,"config",void 0),Object(l.a)([Object(d.b)({readOnly:!0,dependsOn:["service"]})],ft.prototype,"fieldsIndex",null),Object(l.a)([Object(d.b)()],ft.prototype,"processor",void 0),Object(l.a)([Object(d.b)({constructOnly:!0})],ft.prototype,"remoteClient",void 0),Object(l.a)([Object(d.b)({constructOnly:!0})],ft.prototype,"service",void 0),Object(l.a)([Object(d.b)({dependsOn:["tileStore"]})],ft.prototype,"spatialReference",null),Object(l.a)([Object(d.b)()],ft.prototype,"updating",null);var dt=ft=Object(l.a)([Object(v.a)("esri.views.2d.layers.features.controllers.FeatureController2D")],ft),vt=new Set;function pt(){return vt}var yt=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(){var e;return Object(s.a)(this,r),(e=t.apply(this,arguments)).controller=null,e.processor=null,e.remoteClient=null,e.tileStore=null,e.service=null,e.viewState=null,e}return Object(u.a)(r,[{key:"initialize",value:function(){var e=this;this.handles.add(this.watch("updating",(function(t){e.remoteClient.invoke("setUpdating",t).catch((function(e){}))})))}},{key:"destroy",value:function(){var e,t,r;null==(e=this.controller)||e.destroy(),null==(t=this.processor)||t.destroy(),null==(r=this.tileStore)||r.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}},{key:"updating",get:function(){return!this.controller||this.controller.updating}},{key:"startup",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.service,n=t.config,i=t.tileInfo,this.service=r,this.tileStore||(s=new _.a(b.a.fromJSON(i)),this.tileStore=new m.a(s)),e.next=4,this._configure(n);case 4:this.tileStore.clear();case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateTiles",value:function(){var e=Object(i.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.tileStore.updateTiles(t);case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.config,n=t.pause,i=O.empty(),e.next=4,Object(p.b)([this.processor.update(i,r),this.controller.update(i,r,n)]);case 4:return e.abrupt("return",i.toJSON());case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"invalidate",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=O.create(t),n=this.controller.invalidate(r),e.next=3,this.remoteClient.invoke("setUpdating",this.updating);case 3:return e.abrupt("return",n);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setViewState",value:function(e){var t=g.a.fromJSON(e);this._set("viewState",t)}},{key:"_configure",value:function(){var e=Object(i.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(p.b)([this._handleControllerConfig(t),this._handleProcessorConfig(t)]);case 2:return this.controller.processor=this.processor,e.next=5,this.update({config:t});case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_handleControllerConfig",value:function(){var e=Object(i.a)(a.a.mark((function e(t){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._createController(this.service,t);case 2:return r=e.sent,e.next=5,r.startup();case 5:return e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_handleProcessorConfig",value:function(){var e=Object(i.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._createProcessor(this.service,t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createController",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.controller&&this.controller.destroy(),n=this.tileStore,i=this.remoteClient,s=new dt({service:t,config:r,tileStore:n,remoteClient:i}),e.abrupt("return",(this.controller=s,s));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createProcessor",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s,u,o;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.schema.processors[0].type,e.next=3,k(n);case 3:return i=e.sent.default,s=this.remoteClient,u=this.tileStore,o=new i({service:t,config:r,tileStore:u,remoteClient:s}),e.abrupt("return",(this.processor&&this.processor.destroy(),this.processor=o,o));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(y.a);Object(l.a)([Object(d.b)()],yt.prototype,"controller",void 0),Object(l.a)([Object(d.b)()],yt.prototype,"processor",void 0),Object(l.a)([Object(d.b)({dependsOn:["controller.updating"]})],yt.prototype,"updating",null),Object(l.a)([Object(d.b)()],yt.prototype,"viewState",void 0);var bt=yt=Object(l.a)([Object(v.a)("esri.views.2d.layers.features.Pipeline")],yt);t.default=bt},780:function(e,t,r){"use strict";r.d(t,"a",(function(){return w})),r.d(t,"b",(function(){return S})),r.d(t,"c",(function(){return v})),r.d(t,"d",(function(){return s})),r.d(t,"e",(function(){return l})),r.d(t,"f",(function(){return c})),r.d(t,"g",(function(){return u})),r.d(t,"h",(function(){return E})),r.d(t,"i",(function(){return C})),r.d(t,"j",(function(){return f})),r.d(t,"k",(function(){return h})),r.d(t,"l",(function(){return T})),r.d(t,"m",(function(){return R})),r.d(t,"n",(function(){return o})),r.d(t,"o",(function(){return F})),r.d(t,"p",(function(){return n})),r.d(t,"q",(function(){return a})),r.d(t,"r",(function(){return L})),r.d(t,"s",(function(){return g})),r.d(t,"t",(function(){return _})),r.d(t,"u",(function(){return m})),r.d(t,"v",(function(){return k})),r.d(t,"w",(function(){return b})),r.d(t,"x",(function(){return y})),r.d(t,"y",(function(){return x})),r.d(t,"z",(function(){return O})),r.d(t,"A",(function(){return j})),r.d(t,"B",(function(){return I})),r.d(t,"C",(function(){return p})),r.d(t,"D",(function(){return d})),r.d(t,"E",(function(){return A})),r.d(t,"F",(function(){return i})),r.d(t,"G",(function(){return D})),r.d(t,"H",(function(){return q})),r.d(t,"I",(function(){return M}));var n=1e-30,a=4294967295,i=512,s=128,u=8,o=29,c=1,l=16,h=50,f=10,d=8,v={metrics:{width:15,height:17,left:0,top:-7,advance:14}},p=0,y=0,b=0,g=1,_=2,m=3,k=4,x=5,O=6,j=5,I=6,w=1,S=2,F=2,T=1,C=2,E=4,A=2.5,R=6,M=5,q=6,D=1.15,L=2},781:function(e,t,r){"use strict";var n,a,i,s,u,o,c;r.d(t,"a",(function(){return c})),r.d(t,"b",(function(){return s})),r.d(t,"c",(function(){return i})),r.d(t,"d",(function(){return n})),r.d(t,"e",(function(){return u})),r.d(t,"f",(function(){return o})),function(e){e[e.FILL=0]="FILL",e[e.LINE=1]="LINE",e[e.MARKER=2]="MARKER",e[e.TEXT=3]="TEXT",e[e.LABEL=4]="LABEL"}(n||(n={})),function(e){e[e.SUCCEEDED=0]="SUCCEEDED",e[e.FAILED_OUT_OF_MEMORY=1]="FAILED_OUT_OF_MEMORY"}(a||(a={})),function(e){e[e.NONE=0]="NONE",e[e.MAP=1]="MAP",e[e.LABEL=2]="LABEL",e[e.LABEL_ALPHA=4]="LABEL_ALPHA",e[e.HITTEST=8]="HITTEST",e[e.HIGHLIGHT=16]="HIGHLIGHT",e[e.CLIP=32]="CLIP",e[e.DEBUG=64]="DEBUG",e[e.NUM_DRAW_PHASES=9]="NUM_DRAW_PHASES"}(i||(i={})),function(e){e[e.SIZE=0]="SIZE",e[e.COLOR=1]="COLOR",e[e.OPACITY=2]="OPACITY",e[e.ROTATION=3]="ROTATION"}(s||(s={})),function(e){e[e.NONE=0]="NONE",e[e.OPACITY=1]="OPACITY",e[e.COLOR=2]="COLOR",e[e.ROTATION=4]="ROTATION",e[e.SIZE_MINMAX_VALUE=8]="SIZE_MINMAX_VALUE",e[e.SIZE_SCALE_STOPS=16]="SIZE_SCALE_STOPS",e[e.SIZE_FIELD_STOPS=32]="SIZE_FIELD_STOPS",e[e.SIZE_UNIT_VALUE=64]="SIZE_UNIT_VALUE"}(u||(u={})),function(e){e[e.MINMAX_TARGETS_OUTLINE=128]="MINMAX_TARGETS_OUTLINE",e[e.SCALE_TARGETS_OUTLINE=256]="SCALE_TARGETS_OUTLINE",e[e.FIELD_TARGETS_OUTLINE=512]="FIELD_TARGETS_OUTLINE",e[e.UNIT_TARGETS_OUTLINE=1024]="UNIT_TARGETS_OUTLINE"}(o||(o={})),function(e){e[e.SPRITE=0]="SPRITE",e[e.GLYPH=1]="GLYPH"}(c||(c={}))},782:function(e,t,r){"use strict";r.d(t,"a",(function(){return D})),r.d(t,"b",(function(){return F})),r.d(t,"c",(function(){return T})),r.d(t,"d",(function(){return q})),r.d(t,"e",(function(){return L})),r.d(t,"f",(function(){return U})),r.d(t,"g",(function(){return A})),r.d(t,"h",(function(){return R})),r.d(t,"i",(function(){return P})),r.d(t,"j",(function(){return z})),r.d(t,"k",(function(){return m})),r.d(t,"l",(function(){return M})),r.d(t,"m",(function(){return C})),r.d(t,"n",(function(){return E})),r.d(t,"o",(function(){return S}));var n=r(9),a=r(12),i=(r(13),r(14)),s=r(23),u=(r(39),r(36),r(243),r(96),r(361),r(464),r(781)),o=(r(786),r(2)),c=r(3),l=r(120),h=function(){function e(){Object(o.a)(this,e),this.color=[0,0,0,0],this.haloColor=[0,0,0,0],this.haloSize=0,this.size=12,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}return Object(c.a)(e,[{key:"acquire",value:function(e,t,r,n,a,i,s,u,o){this.color=e,this.haloColor=t,this.haloSize=r,this.size=n,this.angle=a,this.offsetX=i,this.offsetY=s,this.hAnchor=u,this.vAnchor=o}},{key:"release",value:function(){this.color[0]=this.color[1]=this.color[2]=this.color[3]=0,this.haloColor[0]=this.haloColor[1]=this.haloColor[2]=this.haloColor[3]=0,this.haloSize=0,this.size=0,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}}]),e}();h.pool=new l.a(h);var f=i.a.getLogger("esri.views.2d.engine.webgl.Utils");function d(e){var t,r={},n=Object(a.a)(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;r[i.name]=i.strideInBytes}}catch(s){n.e(s)}finally{n.f()}return r}var v=d([{name:"geometry",strideInBytes:32,divisor:0}]),p=d([{name:"geometry",strideInBytes:32,divisor:0}]),y=d([{name:"geometry",strideInBytes:12,divisor:0}]),b=d([{name:"geometry",strideInBytes:36,divisor:0}]),g=d([{name:"geometry",strideInBytes:32,divisor:0}]),_=d([{name:"geometry",strideInBytes:36,divisor:0}]);function m(e,t){switch(e){case u.d.MARKER:return v;case u.d.FILL:return t?y:p;case u.d.LINE:return b;case u.d.TEXT:return g;case u.d.LABEL:return _}}var k=["geometry"],x=["geometry"],O=["geometry"],j=["geometry"],I=["geometry"];function w(e){switch(e){case u.d.MARKER:return k;case u.d.FILL:return x;case u.d.LINE:return O;case u.d.TEXT:return j;case u.d.LABEL:return I}}function S(e){switch(e%4){case 0:case 2:return 4;case 1:case 3:return 1}}function F(e,t){switch(t%4){case 0:case 2:return new Uint32Array(Math.floor(e*t/4));case 1:case 3:return new Uint8Array(e*t)}}function T(e,t){switch(t%4){case 0:case 2:return new Uint32Array(e);case 1:case 3:return new Uint8Array(e)}}function C(e){return null!=e}function E(e){return"number"==typeof e}function A(e,t){switch(e){case"butt":return 0;case"round":return t?2:1;case"square":return 2;default:return f.error(new s.a("mapview-invalid-type","Cap type ".concat(e," is not a valid option. Defaulting to round"))),1}}function R(e){switch(e){case"miter":return 2;case"bevel":return 0;case"round":return 1;default:return f.error(new s.a("mapview-invalid-type","Join type ".concat(e," is not a valid option. Defaulting to round"))),1}}function M(e){switch(e){case"opacity":return u.b.OPACITY;case"color":return u.b.COLOR;case"rotation":return u.b.ROTATION;case"size":return u.b.SIZE;default:return f.error("Cannot interpret unknown vv: ".concat(e)),null}}function q(e,t,r,n,a,i,s){for(var u in i)for(var o=i[u].stride,c=S(o),l=i[u].data,h=r[u].data,f=o*a.vertexCount/c,d=o*e/c,v=o*a.vertexFrom/c,p=0;p<f;++p)h[p+d]=l[p+v];for(var y=a.indexCount,b=0;b<y;++b)n[b+t]=s[b+a.indexFrom]-a.vertexFrom+e}var D={geometry:35044};function L(e,t){for(var r=[],n=0;n<5;++n){var i,s=w(n),u={},o=Object(a.a)(s);try{for(o.s();!(i=o.n()).done;){var c=i.value;u[c]={data:t(n,c)}}}catch(l){o.e(l)}finally{o.f()}r.push({data:e(n),buffers:u})}return r}function z(e){switch(e){case 5121:return 1;case 32819:return 2;case 5126:return 4;default:return void f.error(new s.a("webgl-utils","Unable to handle type ".concat(e)))}}function P(e){switch(e){case 5121:return Uint8Array;case 32819:return Uint16Array;case 5126:return Float32Array;default:return void f.error(new s.a("webgl-utils","Unable to handle type ".concat(e)))}}var N=new Map,U=function(e,t){if(!N.has(e)){var r=function(e){var t={},r=function(r){var a=e[r],i=0;t[r]=a.map((function(e){var t=Object(n.a)(Object(n.a)({},e),{},{normalized:e.normalized||!1,divisor:e.divisor||0,offset:i,stride:0});return i+=e.count*function(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5126:case 5124:case 5125:return 4}}(e.type),t})),t[r].forEach((function(e){return e.stride=i}))};for(var a in e)r(a);return t}(t),i={strides:function(e){var t={};for(var r in e){var n=e[r];t[r]=n.length?n[0].stride:0}return t}(r),bufferLayouts:r,attributes:function(e){var t={};for(var r in e){var n,i=Object(a.a)(e[r]);try{for(i.s();!(n=i.n()).done;){var s=n.value;t[s.name]=s.location}}catch(u){i.e(u)}finally{i.f()}}return t}(t)};N.set(e,i)}return N.get(e)}},784:function(e,t,r){"use strict";r.d(t,"a",(function(){return i})),r.d(t,"b",(function(){return s})),r.d(t,"c",(function(){return a}));var n=new Float32Array(1);new Uint32Array(n.buffer);function a(e){return[255&e,(65280&e)>>>8,(16711680&e)>>>16,(4278190080&e)>>>24]}function i(e,t){return 65535&e|t<<16}function s(e,t,r,n){return 255&e|(255&t)<<8|(255&r)<<16|n<<24}},786:function(e,t,r){"use strict";r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return s})),r.d(t,"c",(function(){return o})),r.d(t,"d",(function(){return c}));var n=r(32),a=r(784);function i(e,t){return Array.isArray(t)?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]):(e[0]=t.r,e[1]=t.g,e[2]=t.b,e[3]=t.a),e}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=e[t+3];return e[t+0]*=n,e[t+1]*=n,e[t+2]*=n,r||(e[t+3]*=255),e}function u(e){return s(i([],e))}function o(e){if(!e)return 0;var t=e.r,r=e.g,n=e.b,i=e.a;return Object(a.b)(t*i,r*i,n*i,255*i)}function c(e){if(!e)return 0;var t=Object(n.a)(e,4),r=t[0],i=t[1],s=t[2],u=t[3];return Object(a.b)(r*(u/255),i*(u/255),s*(u/255),u)}},805:function(e,t,r){"use strict";r.d(t,"a",(function(){return b})),r.d(t,"b",(function(){return p})),r.d(t,"c",(function(){return y}));var n=r(26),a=r(12),i=r(4),s=r(98),u=r(33),o=r(41),c=["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"];function l(e){return e instanceof u.a}function h(e){return e instanceof o.a?Object.keys(e.items):l(e)?Object(s.a)(e).keys():e?Object.keys(e):[]}function f(e,t){return e instanceof o.a?e.items[t]:e[t]}function d(e){return e?e.declaredClass:null}function v(e,t){var r=e.diff;if(r&&"function"==typeof r)return r(e,t);var s=h(e),u=h(t);if(0!==s.length||0!==u.length){if(!s.length||!u.length||function(e,t){return!(!Array.isArray(e)||!Array.isArray(t))&&e.length!==t.length}(e,t))return{type:"complete",oldValue:e,newValue:t};var o,p=u.filter((function(e){return-1===s.indexOf(e)})),y=s.filter((function(e){return-1===u.indexOf(e)})),b=s.filter((function(r){return u.indexOf(r)>-1&&f(e,r)!==f(t,r)})).concat(p,y).sort(),g=d(e);if(g&&c.indexOf(g)>-1&&b.length)return{type:"complete",oldValue:e,newValue:t};var _,m=l(e)&&l(t),k=Object(a.a)(b);try{for(k.s();!(_=k.n()).done;){var x=_.value,O=f(e,x),j=f(t,x),I=void 0;(m||"function"!=typeof O&&"function"!=typeof j)&&O!==j&&(null==O&&null==j||(I=r&&r[x]&&"function"==typeof r[x]?r[x](O,j):"object"==typeof O&&"object"==typeof j&&d(O)===d(j)?v(O,j):{type:"complete",oldValue:O,newValue:j},Object(i.i)(I)&&(Object(i.i)(o)?o.diff[x]=I:o={type:"partial",diff:Object(n.a)({},x,I)})))}}catch(w){k.e(w)}finally{k.f()}return o}}function p(e,t){if(Object(i.h)(e))return!1;var r,n=t.split("."),s=e,u=Object(a.a)(n);try{for(u.s();!(r=u.n()).done;){var o=r.value;if("complete"===s.type)return!0;if("partial"!==s.type)return!1;var c=s.diff[o];if(!c)return!1;s=c}}catch(l){u.e(l)}finally{u.f()}return!0}function y(e,t){var r,n=Object(a.a)(t);try{for(n.s();!(r=n.n()).done;){if(p(e,r.value))return!0}}catch(i){n.e(i)}finally{n.f()}return!1}function b(e,t){if("function"!=typeof e&&"function"!=typeof t&&(e||t))return!e||!t||"object"==typeof e&&"object"==typeof t&&d(e)!==d(t)?{type:"complete",oldValue:e,newValue:t}:v(e,t)}},840:function(e,t,r){"use strict";r.d(t,"a",(function(){return h}));var n=r(12),a=r(2),i=r(3),s=r(58),u=(r(77),r(142)),o=r(359),c=r(889),l=0,h=function(){function e(t){Object(a.a)(this,e),this.type="FeatureSetReader",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._xmin=-1,this._xmax=0,this._ymin=0,this._ymax=0,this._joined=[],this.instance=t}return Object(i.a)(e,[{key:"_hasFilter",get:function(){return-1!==this._xmin}},{key:"getQuantizationTransform",value:function(){throw new Error("Unable to find transform for featureSet")}},{key:"getStorage",value:function(){return this._storage}},{key:"getComputedNumeric",value:function(e){return this.getComputedNumericAtIndex(0)}},{key:"setComputedNumeric",value:function(e,t){return this.setComputedNumericAtIndex(t,0)}},{key:"getComputedString",value:function(e){return this.getComputedStringAtIndex(0)}},{key:"setComputedString",value:function(e,t){return this.setComputedStringAtIndex(0,t)}},{key:"getComputedNumericAtIndex",value:function(e){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),e)}},{key:"setComputedNumericAtIndex",value:function(e,t){this._storage.setComputedNumericAtIndex(this.getDisplayId(),e,t)}},{key:"getComputedStringAtIndex",value:function(e){return this._storage.getComputedStringAtIndex(this.getDisplayId(),e)}},{key:"setComputedStringAtIndex",value:function(e,t){return this._storage.setComputedStringAtIndex(this.getDisplayId(),e,t)}},{key:"transform",value:function(e,t){var r=this.copy();return r._tx=e,r._ty=t,r}},{key:"extent",value:function(e,t,r,n){var a=this.copy();return a._xmin=e,a._xmax=r,a._ymin=t,a._ymax=n,a}},{key:"hasFilter",value:function(){return this._hasFilter}},{key:"readAttribute",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._readAttribute(e,t);if(void 0!==r)return r;var a,i=Object(n.a)(this._joined);try{for(i.s();!(a=i.n()).done;){var s=a.value;s.setIndex(this.getIndex());var u=s._readAttribute(e,t);if(void 0!==u)return u}}catch(o){i.e(o)}finally{i.f()}}},{key:"readAttributes",value:function(){return this._readAttributes()}},{key:"joinAttributes",value:function(e){this._joined.push(e)}},{key:"readArcadeFeature",value:function(){return this}},{key:"geometry",value:function(){var e=this.readHydratedGeometry(),t=Object(o.k)(e,this.geometryType,this.hasZ,this.hasM),r=Object(s.a)(t);return r.spatialReference=this._arcadeSpatialReference,r}},{key:"field",value:function(e){return this.readAttribute(e,!0)}},{key:"hasField",value:function(e){return!0}},{key:"setField",value:function(e,t){}},{key:"keys",value:function(){return[]}},{key:"castToText",value:function(){return""}},{key:"_computeCentroid",value:function(){if("esriGeometryPolygon"!==this.geometryType)return null;var e=this.readUnquantizedGeometry();if(!e||e.hasIndeterminateRingOrder)return null;var t=this.getQuantizationTransform();return Object(c.a)(new u.a,e,this.hasM,this.hasZ,t)}},{key:"copyInto",value:function(e){e.seen=this.seen,e._storage=this._storage,e._arcadeSpatialReference=this._arcadeSpatialReference,e._joined=this._joined,e._tx=this._tx,e._ty=this._ty,e._xmin=this._xmin,e._xmax=this._xmax,e._ymin=this._ymin,e._ymax=this._ymax}}],[{key:"createInstance",value:function(){return l=++l>65535?0:l}}]),e}()},845:function(e,t,r){"use strict";r.d(t,"a",(function(){return a})),r.d(t,"b",(function(){return n}));var n=function(e,t){return e&&function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.warn.apply(t,["DEBUG:"].concat(r))}||function(){return null}},a=!1},876:function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var n=r(14),a=r(23),i=r(781),s=r(782),u=n.a.getLogger("esri.views.2d.engine.webgl");function o(e){return Object(s.n)(e.minDataValue)&&Object(s.n)(e.maxDataValue)&&null!=e.minSize&&null!=e.maxSize?i.e.SIZE_MINMAX_VALUE:(e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops)?i.e.SIZE_SCALE_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels)?i.e.SIZE_FIELD_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit?i.e.SIZE_UNIT_VALUE:(u.error(new a.a("mapview-bad-type","Found invalid size VisualVariable",e)),i.e.NONE)}},878:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));var n=r(2),a=r(3),i=r(4),s=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Number.POSITIVE_INFINITY;Object(n.a)(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=isFinite(t)?new Array(t):[]}return Object(a.a)(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return isFinite(this.maxSize)?this._buffer[(this._start+this.size++)%this.maxSize]=e:this._buffer[this._start+this.size++]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"clear",value:function(){for(;Object(i.i)(this.dequeue()););}}]),e}()},881:function(e,t,r){"use strict";r.d(t,"a",(function(){return d}));var n=r(32),a=r(12),i=r(2),s=r(3),u=r(61),o=r(55),c=r(5),l=r(6),h=r(359),f=r(840),d=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e,n,a){var s;return Object(i.a)(this,r),(s=t.call(this,e))._featureIndex=-1,s._dateFields=new Set,s._geometryType=a,s._features=n,s}return Object(s.a)(r,[{key:"_current",get:function(){return this._features[this._featureIndex]}},{key:"geometryType",get:function(){return this._geometryType}},{key:"hasFeatures",get:function(){return!!this._features.length}},{key:"hasNext",get:function(){return this._featureIndex+1<this._features.length}},{key:"exceededTransferLimit",get:function(){return this._exceededTransferLimit}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"getApproximateSize",value:function(){return this._features.length}},{key:"getCursor",value:function(){return this.copy()}},{key:"getQuantizationTransform",value:function(){return this._transform}},{key:"getAttributeHash",value:function(){var e="";for(var t in this._current.attributes)e+=this._current.attributes[t];return e}},{key:"getIndex",value:function(){return this._featureIndex}},{key:"setIndex",value:function(e){this._featureIndex=e}},{key:"getObjectId",value:function(){return this._current.objectId}},{key:"getDisplayId",value:function(){return this._current.displayId}},{key:"setDisplayId",value:function(e){this._current.displayId=e}},{key:"getGroupId",value:function(){return this._current.groupId}},{key:"setGroupId",value:function(e){this._current.groupId=e}},{key:"copy",value:function(){var e=new r(this.instance,this._features,this.geometryType);return this.copyInto(e),e}},{key:"next",value:function(){if(!this._hasFilter)return++this._featureIndex<this._features.length;for(;++this._featureIndex<this._features.length&&!this._passesFilter(););return this._featureIndex<this._features.length}},{key:"readLegacyFeature",value:function(){return Object(h.i)(this._current,this.geometryType,this.hasZ,this.hasM)}},{key:"readOptimizedFeature",value:function(){return this._current}},{key:"readLegacyPointGeometry",value:function(){var e=this.readGeometry();return e?{x:e.coords[0],y:e.coords[1]}:null}},{key:"readLegacyGeometry",value:function(){var e=this.readGeometry();return Object(h.k)(e,this.geometryType,this.hasZ,this.hasM)}},{key:"readLegacyCentroid",value:function(){var e=this.readCentroid();return e?{x:e.coords[0],y:e.coords[1]}:null}},{key:"readGeometryArea",value:function(){return Object(h.s)(this._current.geometry,2)}},{key:"readUnquantizedGeometry",value:function(){var e=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!e)return e;var t=e.clone();return function(e){var t,r=e.coords,n=e.lengths,i=0,s=Object(a.a)(n);try{for(s.s();!(t=s.n()).done;){for(var u=t.value,o=1;o<u;o++)r[2*(i+o)]+=r[2*(i+o)-2],r[2*(i+o)+1]+=r[2*(i+o)-1];i+=u}}catch(c){s.e(c)}finally{s.f()}}(t),t}},{key:"readHydratedGeometry",value:function(){var e=this._current.geometry;if(!e)return null;var t=e.clone();return Object(h.y)(t,t,this.hasZ,this.hasM,this._transform),t}},{key:"getXHydrate",value:function(){var e=this._current.geometry.coords[0]+this._tx,t=this.getQuantizationTransform();return e*t.scale[0]+t.translate[0]}},{key:"getYHydrate",value:function(){var e=this._current.geometry.coords[1]+this._ty,t=this.getQuantizationTransform();return t.translate[1]-e*t.scale[1]}},{key:"readGeometry",value:function(){if(!this._current.hasGeometry)return null;var e=this._current.geometry.clone();if(e.isPoint)return e.coords[0]+=this._tx,e.coords[1]+=this._ty,e;var t,r=0,n=Object(a.a)(e.lengths);try{for(n.s();!(t=n.n()).done;){var i=t.value;e.coords[2*r]+=this._tx,e.coords[2*r+1]+=this._ty,r+=i}}catch(s){n.e(s)}finally{n.f()}return e}},{key:"readCentroid",value:function(){if(!this._current.hasGeometry)return null;if(!this._current.centroid){var e=this._computeCentroid();if(!e)return null;e.coords[0]-=this._tx,e.coords[1]-=this._ty,this._current.centroid=e}var t=this._current.centroid.clone();return t.coords[0]+=this._tx,t.coords[1]+=this._ty,t}},{key:"_readAttribute",value:function(e,t){var r=this._current.attributes[e];if(void 0!==r)return t&&this._dateFields.has(e)?new Date(r):r;var n=this.readAttributes(),a=e.toLocaleLowerCase().trim();for(var i in n)if(i.toLocaleLowerCase().trim()===a){var s=this._current.attributes[i];return this._dateFields.has(i)?new Date(s):s}}},{key:"copyInto",value:function(e){Object(u.a)(Object(o.a)(r.prototype),"copyInto",this).call(this,e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._dateFields=this._dateFields}},{key:"_readAttributes",value:function(){return this._current.attributes}},{key:"_passesFilter",value:function(){if(!this._hasFilter)return!0;var e=0,t=0;switch(this.geometryType){case"esriGeometryPoint":var r=this._current.geometry;if(!r)return!1;var a=Object(n.a)(r.coords,2);e=a[0],t=a[1];break;case"esriGeometryPolygon":var i,s,u=this.readCentroid();if(!u)return!1;i=u.coords,e=(s=Object(n.a)(i,2))[0],t=s[1],e-=this._tx,t-=this._ty;break;default:return!1}return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax}}],[{key:"fromFeatures",value:function(e,t,n){for(var a=Object(h.c)([],e,t,!1,!1,n),i=0;i<a.length;i++)a[i].displayId=e[i].displayId;return r.fromOptimizedFeatures(a,t)}},{key:"fromFeatureSet",value:function(e,t){var n=Object(h.b)(e,t);return r.fromOptimizedFeatureSet(n)}},{key:"fromOptimizedFeatureSet",value:function(e){var t=e.features,n=e.geometryType,i=r.fromOptimizedFeatures(t,n);i._exceededTransferLimit=e.exceededTransferLimit,i._transform=e.transform;var s,u=Object(a.a)(e.fields);try{for(u.s();!(s=u.n()).done;){var o=s.value;"esriFieldTypeDate"===o.type&&i._dateFields.add(o.name)}}catch(c){u.e(c)}finally{u.f()}return i}},{key:"fromOptimizedFeatures",value:function(e,t,n){var a=new r(f.a.createInstance(),e,t);return a._transform=n,a}}]),r}(f.a)},888:function(e,t,r){"use strict";r.d(t,"a",(function(){return p})),r.d(t,"b",(function(){return h}));var n=r(9),a=r(12),i=r(4),s=r(36),u=r(780),o=r(781),c=r(786),l=r(876);function h(e,t){if(!e||!t)return e;switch(t){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e}function f(e){return e.map((function(e){return function(e){return{value:e.value,size:Object(s.j)(e.size)}}(e)}))}function d(e){if("string"==typeof e||"number"==typeof e)return Object(s.j)(e);var t=e;return{type:"size",expression:t.expression,stops:f(t.stops)}}var v=function(e){for(var t=[],r=[],n=f(e),a=n.length,i=0;i<6;i++){var o=n[Math.min(i,a-1)];t.push(o.value),r.push(null==o.size?u.p:Object(s.g)(o.size))}return{values:new Float32Array(t),sizes:new Float32Array(r)}};function p(e){var t=e&&e.length>0?{}:null,r=t?{}:null;if(!t)return{vvFields:t,vvRanges:r};var i,s=Object(a.a)(e);try{for(s.s();!(i=s.n()).done;){var u=i.value;if(u.field&&(t[u.type]=u.field),"size"===u.type){r.size||(r.size={});var c=u;switch(Object(l.a)(c)){case o.e.SIZE_MINMAX_VALUE:r.size.minMaxValue={minDataValue:c.minDataValue,maxDataValue:c.maxDataValue,minSize:d(c.minSize),maxSize:d(c.maxSize)};break;case o.e.SIZE_SCALE_STOPS:r.size.scaleStops={stops:f(c.stops)};break;case o.e.SIZE_FIELD_STOPS:if(c.levels){var h={};for(var p in c.levels)h[p]=v(c.levels[p]);r.size.fieldStops={type:"level-dependent",levels:h}}else r.size.fieldStops=Object(n.a)({type:"static"},v(c.stops));break;case o.e.SIZE_UNIT_VALUE:r.size.unitValue={unit:c.valueUnit,valueRepresentation:c.valueRepresentation}}}else if("color"===u.type)r.color=g(u);else if("opacity"===u.type)r.opacity=y(u);else if("rotation"===u.type){var b=u;r.rotation={type:b.rotationType}}}}catch(_){s.e(_)}finally{s.f()}return{vvFields:t,vvRanges:r}}function y(e){var t={values:[0,0,0,0,0,0,0,0],opacities:[0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;if(e.stops.length>8)return null;for(var r=e.stops,n=0;n<8;++n){var a=r[Math.min(n,r.length-1)];t.values[n]=a.value,t.opacities[n]=a.opacity}}else{if(!(e.stops&&e.stops.length>=0))return null;for(var i=e.stops&&e.stops.length>=0&&e.stops[0].opacity,s=0;s<8;s++)t.values[s]=1/0,t.opacities[s]=i}return t}function b(e,t,r){e[4*t+0]=r.r/255,e[4*t+1]=r.g/255,e[4*t+2]=r.b/255,e[4*t+3]=r.a}function g(e){if(Object(i.h)(e))return null;if(e.normalizationField)return null;var t={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;if(e.stops.length>8)return null;t.field=e.field;for(var r=e.stops,n=0;n<8;++n){var a=r[Math.min(n,r.length-1)];t.values[n]=a.value,b(t.colors,n,a.color)}}else{if(!(e.stops&&e.stops.length>=0))return null;for(var s=e.stops&&e.stops.length>=0&&e.stops[0].color,u=0;u<8;u++)t.values[u]=1/0,b(t.colors,u,s)}for(var o=0;o<32;o+=4)Object(c.b)(t.colors,o,!0);return t}},895:function(e,t,r){"use strict";r.d(t,"a",(function(){return T})),r.d(t,"b",(function(){return I}));var n=r(10),a=r.n(n),i=r(21),s=r(12),u=r(2),o=r(3),c=r(13),l=r(4),h=r(14),f=r(23),d=r(16),v=r(39),p=r(805),y=r(791),b=r(780),g=r(782),_=r(845),m=r(888),k=h.a.getLogger("esri.views.layers.2d.features.support.AttributeStore"),x=Object(_.b)(_.a,k),O=function(e){return(2147483648&e)>>>31},j=function(e){return 2147483647&e};function I(e){return 1===O(e)}var w={sharedArrayBuffer:Object(c.a)("esri-shared-array-buffer"),atomics:Object(c.a)("esri-atomics")};function S(e,t){return function(r){return t(e(r))}}var F=function(){function e(t,r,n,a){Object(u.a)(this,e),this.size=0,this.texelSize=4;var i=a.pixelType,s=a.layout,o=a.textureOnly;this.textureOnly=o||!1,this.pixelType=i,this._ctype=r,this.layout=s,this._resetRange(),this._shared=t,this.size=n,o||(this.data=this._initData(i,n,t,r))}return Object(o.a)(e,[{key:"buffer",get:function(){return Object(l.a)(this.data,(function(e){return e.buffer}))}},{key:"unsetComponentAllTexels",value:function(e,t){for(var r=Object(l.o)(this.data),n=0;n<this.size*this.size;n++)r[n*this.texelSize+e]&=~t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}},{key:"setComponentAllTexels",value:function(e,t){for(var r=Object(l.o)(this.data),n=0;n<this.size*this.size;n++)r[n*this.texelSize+e]|=255&t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}},{key:"setComponent",value:function(e,t,r){var n,a=Object(l.o)(this.data),i=Object(s.a)(r);try{for(i.s();!(n=i.n()).done;){var u=n.value;a[u*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,u),this.dirtyEnd=Math.max(this.dirtyEnd,u)}}catch(o){i.e(o)}finally{i.f()}}},{key:"setComponentTexel",value:function(e,t,r){Object(l.o)(this.data)[r*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}},{key:"unsetComponentTexel",value:function(e,t,r){Object(l.o)(this.data)[r*this.texelSize+e]&=~t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}},{key:"getData",value:function(e,t){var r=j(e);return Object(l.o)(this.data)[r*this.texelSize+t]}},{key:"setData",value:function(e,t,r){var n=j(e),a=1<<t;0!=(this.layout&a)?(this.data[n*this.texelSize+t]=r,this.dirtyStart=Math.min(this.dirtyStart,n),this.dirtyEnd=Math.max(this.dirtyEnd,n)):k.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}},{key:"lock",value:function(){5121===this.pixelType&&this._shared&&w.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}},{key:"unlock",value:function(){5121===this.pixelType&&this._shared&&w.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}},{key:"expand",value:function(e){if(this.size=e,!this.textureOnly){var t=this._initData(this.pixelType,e,this._shared,this._ctype),r=Object(l.o)(this.data);t.set(r),this.data=t}}},{key:"toMessage",value:function(){var e=this.dirtyStart,t=this.dirtyEnd,r=this.texelSize;if(e>t)return null;this._resetRange();var n=!(this._shared||"local"===this._ctype),a=this.pixelType,i=this.layout,s=Object(l.o)(this.data);return s.slice?{start:e,end:t,data:n&&s.slice(e*r,(t+1)*r)||null,pixelType:a,layout:i}:n?{start:e,end:t,data:new(Object(g.i)(this.pixelType))(Array.prototype.slice.call(this.data,e*r,(t+1)*r)),pixelType:a,layout:i}:{start:e,end:t,data:null,pixelType:a,layout:i}}},{key:"_initData",value:function(e,t,r,n){for(var a=r&&"local"!==n?SharedArrayBuffer:ArrayBuffer,i=Object(g.i)(e),s=new i(new a(t*t*4*i.BYTES_PER_ELEMENT)),u=0;u<s.length;u+=4)s[u+1]=255;return s}},{key:"_resetRange",value:function(){this.dirtyStart=2147483647,this.dirtyEnd=0}}]),e}(),T=function(){function e(t,r){Object(u.a)(this,e),this._client=t,this.config=r,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(b.o),this._targetType=0,this._abortController=Object(d.d)(),this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;var n=r.supportsTextureFloat?5126:5121;x("Creating AttributeStore ".concat(w.sharedArrayBuffer?"with":"without"," shared memory")),this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:n,layout:15},{pixelType:n,layout:15}],this._blocks=this._blockDescriptors.map((function(){return null}))}return Object(o.a)(e,[{key:"destroy",value:function(){this._abortController.abort()}},{key:"hasScaleExpr",get:function(){return this._hasScaleExpr}},{key:"_signal",get:function(){return this._abortController.signal}},{key:"update",value:function(e,t){this.config=t;var r=t.schema.processors[0].storage,n=Object(p.a)(this._schema,r);if((e.targets.feature||e.targets.aggregate)&&(e.storage.data=!0),n&&(Object(c.a)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",n),e.storage.data=!0,this._schema=r,this._attributeComputeMap.clear(),!Object(l.h)(r))){switch(r.target){case"feature":this._targetType=0;break;case"aggregate":this._targetType=1}var a,i=Object(s.a)(r.mapping);try{for(i.s();!(a=i.n()).done;){var u=a.value;this._bindAttribute(u)}}catch(o){i.e(o)}finally{i.f()}}}},{key:"onTileData",value:function(e,t){if(!Object(l.h)(t.addOrUpdate))for(var r=t.addOrUpdate.getCursor();r.next();){var n=r.getDisplayId();this.setAttributeData(n,r)}}},{key:"invalidateResources",value:function(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=Object(d.d)()}},{key:"setHighlight",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,u,o,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=this._getBlock(0),i=r.map((function(e){return j(e)})),n.lock(),n.unsetComponentAllTexels(0,1),n.setComponent(0,1,i),n.unlock(),this._idsToHighlight.clear(),u=Object(s.a)(t);try{for(u.s();!(o=u.n()).done;)c=o.value,this._idsToHighlight.add(c)}catch(a){u.e(a)}finally{u.f()}return e.next=6,this.sendUpdates();case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"updateFilters",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r){var n,i,s,u,o,l=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.config,i=r.service,s=r.spatialReference,u=n.filters,o=u.map((function(e,t){return l._updateFilter(e,t,i,s)})),e.next=3,Object(d.b)(o);case 3:if(e.t0=e.sent.some((function(e){return e})),!e.t0){e.next=6;break}t.storage.filters=!0,Object(c.a)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed");case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"setData",value:function(e,t,r,n){var a=j(e);this._ensureSizeForTexel(a),this._getBlock(t).setData(e,r,n)}},{key:"getData",value:function(e,t,r){return this._getBlock(t).getData(e,r)}},{key:"getHighlightFlag",value:function(e){return this._idsToHighlight.has(e)?b.l:0}},{key:"unsetAttributeData",value:function(e){var t=j(e);this._getBlock(0).setData(t,0,0)}},{key:"setAttributeData",value:function(e,t){var r=this,n=j(e);if(this._ensureSizeForTexel(n),this._getBlock(0).setData(n,0,this.getFilterFlags(t)),this._targetType===O(e)){var a=this._attributeComputeMap,i=this.config.supportsTextureFloat?1:2;a.size&&a.forEach((function(e,a){var s=a*i%4,u=Math.floor(a*i/4),o=r._getBlock(u+b.b),c=e(t);if(r.config.supportsTextureFloat)o.setData(n,s,c);else if(c===b.p)o.setData(n,s,255),o.setData(n,s+1,255);else{var l=Object(v.c)(Math.round(c),-32767,32766)+32768,h=255&l,f=(65280&l)>>8;o.setData(n,s,h),o.setData(n,s+1,f)}}))}}},{key:"sendUpdates",value:function(){var e=this;if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=Object(d.g)(),this._nextUpdate.promise;var t={blocks:this._blocks.map((function(e){return Object(l.i)(e)?e.toMessage():null}))};return this._currUpdate=this._createResources().then((function(){var r=function(){if(e._currUpdate=null,e._nextUpdate){var t=e._nextUpdate;e._nextUpdate=null,e.sendUpdates().then((function(){return t.resolve()}))}},n=e._client.update(t,e._signal).then(r).catch(r);return e._client.render(e._signal),n})).catch((function(t){return Object(d.n)(t)?(e._createResourcesPromise=null,e._createResources()):(k.error(new f.a("mapview-attribute-store","Encountered an error during client update",t)),Object(d.u)())})),this._currUpdate}},{key:"_ensureSizeForTexel",value:function(e){for(;e>=this._size*this._size;)if(this._expand())return}},{key:"_bindAttribute",value:function(e){var t;if(null!=e.fieldIndex)e.normalizationField&&k.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),t=function(t){return t.getComputedNumericAtIndex(e.fieldIndex)};else{if(!e.field)return;t=e.normalizationField?function(t){var r=t.readAttribute(e.normalizationField);return r?t.readAttribute(e.field)/r:null}:function(t){return t.readAttribute(e.field)}}e.valueRepresentation&&(t=S(t,(function(t){return Object(m.b)(t,e.valueRepresentation)}))),this._attributeComputeMap.set(e.binding,S(t,(function(e){return null===e||isNaN(e)||e===1/0?b.p:e})))}},{key:"_createResources",value:function(){var e=this;if(Object(l.i)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(b.a),x("Initializing AttributeStore");var t={shared:w.sharedArrayBuffer&&!("local"===this._client.type),size:this._size,blocks:Object(l.k)(this._blocks,(function(e){return{textureOnly:e.textureOnly,buffer:e.buffer,pixelType:e.pixelType}}))},r=this._client.initialize(t,this._signal).catch((function(t){Object(d.n)(t)?e._createResourcesPromise=null:k.error(new f.a("mapview-attribute-store","Encountered an error during client initialization",t))}));return this._createResourcesPromise=r,r.then((function(){return Object(l.h)(e._createResourcesPromise)?e._createResources():void 0})),r}},{key:"_getBlock",value:function(e){var t=this._blocks[e];if(Object(l.i)(t))return t;x("Initializing AttributeBlock at index ".concat(e));var r=w.sharedArrayBuffer,n=this._client.type,a=new F(r,n,this._size,this._blockDescriptors[e]);return this._blocks[e]=a,this._createResourcesPromise=null,a}},{key:"_expand",value:function(){if(this._size<this.config.maxTextureSize){var e=this._size<<=1;return x("Expanding block size to",e,this._blocks),Object(l.f)(this._blocks,(function(t){return t.expand(e)})),this._createResourcesPromise=null,this._size=e,0}return k.error(new f.a("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}},{key:"_updateFilter",value:function(){var e=Object(i.a)(a.a.mark((function e(t,r,n,i){var s,u,o,c,h;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this._filters[r],u=Object(l.i)(s)&&s.hash,s||t){e.next=3;break}return e.abrupt("return",!1);case 3:if(u!==JSON.stringify(t)){e.next=5;break}return e.abrupt("return",!1);case 5:if(!Object(l.h)(t)){e.next=8;break}return o=1<<r+1,c=this._getBlock(0),e.abrupt("return",(this._filters[r]=null,c.setComponentAllTexels(0,o),this.sendUpdates(),!0));case 8:return e.next=10,this._getFilter(r,n);case 10:return h=e.sent,e.next=13,h.update(t,i);case 13:return e.abrupt("return",!0);case 14:case"end":return e.stop()}}),e,this)})));return function(t,r,n,a){return e.apply(this,arguments)}}()},{key:"_getFilter",value:function(){var e=Object(i.a)(a.a.mark((function e(t,n){var i,s,u,o;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this._filters[t],!Object(l.i)(i)){e.next=3;break}return e.abrupt("return",i);case 3:return e.next=5,r.e(85).then(r.bind(null,951));case 5:return s=e.sent,u=s.default,o=new u({geometryType:n.geometryType,hasM:!1,hasZ:!1,timeInfo:n.timeInfo,fieldsIndex:new y.a(n.fields)}),e.abrupt("return",(this._filters[t]=o,o));case 9:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"isVisible",value:function(e){return!!(2&this._getBlock(0).getData(e,0))}},{key:"getFilterFlags",value:function(e){for(var t,r=0,n=(t=e.getDisplayId(),1===O(t)?254:255),a=0;a<this._filters.length;a++){var i=!!(n&1<<a),s=this._filters[a];r|=(!i||Object(l.h)(s)||s.check(e)?1:0)<<a}var u=0;if(this._idsToHighlight.size){var o=e.getObjectId();u=this.getHighlightFlag(o)}return r<<1|u}}]),e}()},896:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));var n=r(2),a=r(3),i=r(125),s=r(62),u=r(107),o=r(393),c=r(229);var l=function(){function e(t,r){Object(n.a)(this,e),this.key=new c.a(0,0,0,0),this.bounds=Object(u.g)(),this.objectIds=new Set,this.key.set(r);var a=t.getLODInfoAt(this.key);this.tileInfoView=t,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=a.resolution,this.scale=a.scale,this.level=a.level,this.needsClear=!0}return Object(a.a)(e,[{key:"id",get:function(){return this.key.id}},{key:"extent",get:function(){return s.a.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}},{key:"transform",get:function(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}},{key:"bbox",get:function(){var e=this.bounds;return{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}}},{key:"clone",value:function(){return new e(this.tileInfoView,this.key)}},{key:"createChildTiles",value:function(){for(var t=this.key.getChildKeys(),r=i.a.acquire(),n=0;n<t.length;n++)r[n]=new e(this.tileInfoView,t[n]);return r}},{key:"getQuantizationParameters",value:function(){return o.a.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}]),e}()},900:function(e,t,r){"use strict";r.d(t,"a",(function(){return b}));var n=r(12),a=r(2),i=r(3),s=r(5),u=r(6),o=r(13),c=r(76),l=r(229),h=r(284),f=r(857),d=r(896),v={added:[],removed:[]},p=new Set,y=new l.a(0,0,0,0),b=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(e){var n;return Object(a.a)(this,r),(n=t.call(this))._tiles=new Map,n._index=Object(f.a)(9,Object(o.a)("csp-restrictions")?function(e){return{minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),n.tiles=[],n.tileScheme=e,n}return Object(i.a)(r,[{key:"destroy",value:function(){this.clear()}},{key:"clear",value:function(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}},{key:"has",value:function(e){return this._tiles.has(e)}},{key:"get",value:function(e){return this._tiles.get(e)}},{key:"findByKey",value:function(e){return this._tiles.get(e.id)}},{key:"intersections",value:function(e,t){var r="string"==typeof e?this.get(e):e;if(!r)return[];var a,i=t*r.resolution,s=r.bounds[0]-i,u=r.bounds[1]-i,o=r.bounds[2]+i,c=r.bounds[3]+i,l=[],h=Object(n.a)(this._index.search({minX:s,minY:u,maxX:o,maxY:c}));try{for(h.s();!(a=h.n()).done;){var f=a.value,d=f.bounds.slice();d[0]=Math.max(d[0],s),d[1]=Math.max(d[1],u),d[2]=Math.min(d[2],o),d[3]=Math.min(d[3],c),d[2]-d[0]>0&&d[3]-d[1]>0&&l.push({bounds:d,tile:f})}}catch(v){h.e(v)}finally{h.f()}return l}},{key:"boundsIntersections",value:function(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}},{key:"updateTiles",value:function(e){var t,r=this,a={added:[],removed:[]},i=Object(n.a)(e.added);try{for(i.s();!(t=i.n()).done;){var s=t.value;if(!this.has(s)){var u=new d.a(this.tileScheme,s);this._tiles.set(s,u),this._index.insert(u),a.added.push(u)}}}catch(f){i.e(f)}finally{i.f()}var o,c=Object(n.a)(e.removed);try{for(c.s();!(o=c.n()).done;){var l=o.value;if(this.has(l)){var h=this.get(l);this._tiles.delete(l),this._index.remove(h),a.removed.push(h)}}}catch(f){c.e(f)}finally{c.f()}this.tiles.length=0,this._tiles.forEach((function(e){return r.tiles.push(e)})),(a.added.length||a.removed.length)&&this.emit("update",a)}},{key:"setViewState",value:function(e){var t=this.tileScheme.getTileCoverage(e,0);if(t){var r=t.spans,a=t.lodInfo,i=a.level;if(r.length>0){var s,u=Object(n.a)(r);try{for(u.s();!(s=u.n()).done;)for(var o=s.value,c=o.row,l=o.colFrom,f=o.colTo,b=l;b<=f;b++){var g=y.set(i,c,a.normalizeCol(b),a.getWorldForColumn(b)).id;if(p.add(g),!this.has(g)){var _=new d.a(this.tileScheme,g);this._tiles.set(g,_),this._index.insert(_),this.tiles.push(_),v.added.push(_)}}}catch(x){u.e(x)}finally{u.f()}}for(var m=this.tiles.length-1;m>=0;m--){var k=this.tiles[m];p.has(k.id)||(this._tiles.delete(k.id),this.tiles.splice(m,1),this._index.remove(k),v.removed.push(k))}(v.added.length||v.removed.length)&&this.emit("update",v),h.a.pool.release(t),p.clear(),v.added.length=0,v.removed.length=0}}}]),r}(c.a)},903:function(e,t,r){"use strict";r.d(t,"a",(function(){return c}));var n=r(12),a=r(2),i=r(3);var s=function(){function e(){Object(a.a)(this,e),this._freeIds=[],this._idCounter=1}return Object(i.a)(e,[{key:"createId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return function(e,t){return((t?2147483648:0)|e)>>>0}(this._getFreeId(),e)}},{key:"releaseId",value:function(e){this._freeIds.push(e)}},{key:"_getFreeId",value:function(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}]),e}(),u=function(){function e(t,r){Object(a.a)(this,e),this._mask=0,this._buf=t,this._mask=r}return Object(i.a)(e,[{key:"_getIndex",value:function(e){return Math.floor(e/32)}},{key:"has",value:function(e){var t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}},{key:"set",value:function(e){var t=this._mask&e,r=this._getIndex(t),n=1<<t%32;this._buf[r]|=n}},{key:"unset",value:function(e){var t=this._mask&e,r=this._getIndex(t),n=1<<t%32;this._buf[r]&=4294967295^n}},{key:"resize",value:function(e){var t=this._buf,r=new Uint32Array(Math.ceil(e/32));r.set(t),this._buf=r}},{key:"or",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}},{key:"and",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}},{key:"xor",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}},{key:"ior",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}},{key:"iand",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}},{key:"ixor",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}},{key:"any",value:function(){for(var e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}},{key:"copy",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}},{key:"clone",value:function(){return new e(this._buf.slice(),this._mask)}},{key:"clear",value:function(){for(var e=0;e<this._buf.length;e++)this._buf[e]=0}},{key:"forEachSet",value:function(e){for(var t=0;t<this._buf.length;t++){var r=this._buf[t],n=32*t;if(r)for(;r;)1&r&&e(n),r>>>=1,n++}}},{key:"countSet",value:function(){var e=0;return this.forEachSet((function(t){e++})),e}}],[{key:"fromBuffer",value:function(t,r){return new e(t,r)}},{key:"create",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4294967295,n=new Uint32Array(Math.ceil(t/32));return new e(n,r)}}]),e}();function o(e,t,r){if(!(e.length>t))for(;e.length<=t;)e.push(r)}var c=function(){function e(){Object(a.a)(this,e),this._numerics=[],this._strings=[],this._idGenerator=new s,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}return Object(i.a)(e,[{key:"createBitset",value:function(){var e=this._bitsets.length;return this._bitsets.push(u.create(this._allocatedSize,2147483647)),e+1}},{key:"getBitset",value:function(e){return this._bitsets[e-1]}},{key:"_expand",value:function(){this._allocatedSize<<=1;var e,t=Object(n.a)(this._bitsets);try{for(t.s();!(e=t.n()).done;){e.value.resize(this._allocatedSize)}}catch(r){t.e(r)}finally{t.f()}}},{key:"_ensureNumeric",value:function(e,t){this._numerics[e]||(this._numerics[e]=[]),o(this._numerics[e],t,0)}},{key:"_ensureInstanceId",value:function(e){o(this._instanceIds,e,0)}},{key:"_ensureString",value:function(e,t){this._strings[e]||(this._strings[e]=[]),o(this._strings[e],t,null)}},{key:"createDisplayId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this._idGenerator.createId();return t>this._allocatedSize&&this._expand(),function(e,t){return((t?2147483648:0)|e)>>>0}(t,e)}},{key:"releaseDisplayId",value:function(e){var t,r=Object(n.a)(this._bitsets);try{for(r.s();!(t=r.n()).done;){t.value.unset(e)}}catch(a){r.e(a)}finally{r.f()}return this._idGenerator.releaseId(2147483647&e)}},{key:"getComputedNumeric",value:function(e,t){return this.getComputedNumericAtIndex(2147483647&e,0)}},{key:"setComputedNumeric",value:function(e,t,r){return this.setComputedNumericAtIndex(2147483647&e,r,0)}},{key:"getComputedString",value:function(e,t){return this.getComputedStringAtIndex(2147483647&e,0)}},{key:"setComputedString",value:function(e,t,r){return this.setComputedStringAtIndex(2147483647&e,0,r)}},{key:"getComputedNumericAtIndex",value:function(e,t){var r=2147483647&e;return this._ensureNumeric(t,r),this._numerics[t][r]}},{key:"setComputedNumericAtIndex",value:function(e,t,r){var n=2147483647&e;this._ensureNumeric(t,n),this._numerics[t][n]=r}},{key:"getInstanceId",value:function(e){var t=2147483647&e;return this._ensureInstanceId(t),this._instanceIds[t]}},{key:"setInstanceId",value:function(e,t){var r=2147483647&e;this._ensureInstanceId(r),this._instanceIds[r]=t}},{key:"getComputedStringAtIndex",value:function(e,t){var r=2147483647&e;return this._ensureString(t,r),this._strings[t][r]}},{key:"setComputedStringAtIndex",value:function(e,t,r){var n=2147483647&e;this._ensureString(t,n),this._strings[t][n]=r}},{key:"getXMin",value:function(e){return this._bounds[4*(2147483647&e)]}},{key:"getYMin",value:function(e){return this._bounds[4*(2147483647&e)+1]}},{key:"getXMax",value:function(e){return this._bounds[4*(2147483647&e)+2]}},{key:"getYMax",value:function(e){return this._bounds[4*(2147483647&e)+3]}},{key:"setBounds",value:function(e,t){var r=t.readHydratedGeometry();if(!r||!r.coords.length)return!1;var n=1/0,a=1/0,i=-1/0,s=-1/0;r.forEachVertex((function(e,t){n=Math.min(n,e),a=Math.min(a,t),i=Math.max(i,e),s=Math.max(s,t)}));var u=2147483647&e;return o(this._bounds,4*u+4,0),this._bounds[4*u]=n,this._bounds[4*u+1]=a,this._bounds[4*u+2]=i,this._bounds[4*u+3]=s,!0}}]),e}()}}]);
//# sourceMappingURL=66.4c29fbb4.chunk.js.map